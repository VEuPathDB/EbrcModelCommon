<?xml version="1.0" encoding="UTF-8"?>
<tuningConfig>

  <import file="orthomclTuningManager.xml"/>

  <!-- EDA table -->	
  <tuningTable name="StudyIdDatasetId" prefixEnabled="false">
    <comment>EDA Study ID, Dataset presenter ID (hash)
    </comment>
    <internalDependency name="DatasetPresenter"/>
    <externalDependency name="sres.ExternalDatabase"/>
    <externalDependency name="sres.ExternalDatabaseRelease"/>
    <externalDependency name="eda.Study"/>
    <sql>
      <![CDATA[
        CREATE TABLE StudyIdDatasetId&1 AS
        SELECT s.STABLE_ID STUDY_STABLE_ID, dp.DATASET_PRESENTER_ID DATASET_ID, dp.SHORT_DISPLAY_NAME AS DATASET_SHORT_DISPLAY_NAME
        FROM EDA.STUDY s
          LEFT JOIN sres.EXTERNALDATABASERELEASE e ON s.EXTERNAL_DATABASE_RELEASE_ID =e.EXTERNAL_DATABASE_RELEASE_ID
          LEFT JOIN sres.EXTERNALDATABASE e2 ON e.EXTERNAL_DATABASE_ID =e2.EXTERNAL_DATABASE_ID
          LEFT JOIN DatasetPresenter dp on e2.name=dp.name
        -- This is TEMPORARY (used for alpha MapVEU Application)
        UNION
        select case
            when d.dataset_presenter_id = 'DS_480c976ef9' then 'VBP_MEGA'
            when d.dataset_presenter_id = 'DS_e18287e335' then '2023-maine-ricinus'
            when d.dataset_presenter_id = 'DS_2b98dd44ab' then '2010-Neafsey-M-S-Bamako'
          else 'NA' end as study_stable_id,
          d.dataset_presenter_id as dataset_id, d.short_display_name as dataset_short_display_name
        from DatasetPresenter d
        where d.dataset_presenter_id in (
          'DS_480c976ef9',
          'DS_e18287e335'
        )
      ]]>
    </sql>
  </tuningTable>


<!-- CHECK AND FIX - regexp_count issue
  <tuningTable name="TaxonAbundance" prefixEnabled="false">
    <comment>lineage abundances</comment>
    <externalDependency name="results.LineageAbundance"/>
    <externalDependency name="sres.ExternalDatabase"/>
    <externalDependency name="sres.ExternalDatabaseRelease"/>
    <externalDependency name="study.ProtocolAppNode"/>
    <externalDependency name="study.StudyLink"/>
    <externalDependency name="study.Study"/>
    <sql>
      <![CDATA[
       CREATE TABLE TaxonAbundance&1 AS
       WITH abundance as (
         select la.protocol_app_node_id,
         'Kingdom' as category,
         1 as taxon_level,
         regexp_replace(la.lineage, '^([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?$', '\1') as term,
         la.raw_count,
         la.relative_abundance
         from results.LineageAbundance la
       UNION
         select la.protocol_app_node_id,
         'Phylum' as category,
         2 as taxon_level,
         regexp_replace(la.lineage, '^([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?$', '\2') as term,
         la.raw_count,
         la.relative_abundance
         from results.LineageAbundance la
         where REGEXP_COUNT(la.lineage, ';') >= 1
       UNION
         select la.protocol_app_node_id,
         'Class' as category,
         3 as taxon_level,
         regexp_replace(la.lineage, '^([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?$', '\3') as term,
         la.raw_count,
         la.relative_abundance
         from results.LineageAbundance la
         where REGEXP_COUNT(la.lineage, ';') >= 2
       UNION
         select la.protocol_app_node_id,
         'Order' as category,
         4 as taxon_level,
         regexp_replace(la.lineage, '^([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?$', '\4') as term,
         la.raw_count,
         la.relative_abundance
         from results.LineageAbundance la
         where REGEXP_COUNT(la.lineage, ';') >= 3
       UNION
         select la.protocol_app_node_id,
         'Family' as category,
         5 as taxon_level,
         regexp_replace(la.lineage, '^([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?$', '\5') as term,
         la.raw_count,
         la.relative_abundance
         from results.LineageAbundance la
         where REGEXP_COUNT(la.lineage, ';') >= 4
       UNION
         select la.protocol_app_node_id,
         'Genus' as category,
         6 as taxon_level,
         regexp_replace(la.lineage, '^([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?$', '\6') as term,
         la.raw_count,
         la.relative_abundance
         from results.LineageAbundance la
         where REGEXP_COUNT(la.lineage, ';') >= 5
       UNION
         select la.protocol_app_node_id,
         'Species' as category,
         7 as taxon_level,
         regexp_replace(la.lineage, '^([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?$', '\7') as term,
         la.raw_count,
         la.relative_abundance
         from results.LineageAbundance la
         where REGEXP_COUNT(la.lineage, ';') = 6
       )
       SELECT  
         abundance.protocol_app_node_id,
         abundance.category,
         abundance.taxon_level,
         abundance.term,
         sum(abundance.raw_count) as agg_count,
         sum(abundance.relative_abundance) as value,
         pan.name AS pan_name,
         ed.name AS dataset_name
       FROM
         abundance,
         study.ProtocolAppNode pan,
         study.StudyLink sl,
         study.Study ss,
         sres.ExternalDatabaseRelease edr,
         sres.ExternalDatabase ed
       WHERE abundance.protocol_app_node_id = pan.protocol_app_node_id
        AND pan.protocol_app_node_id = sl.protocol_app_node_id
        AND sl.study_id = ss.study_id
        AND ss.name not like 'OTU Profiles%'
        AND ss.external_database_release_id = edr.external_database_release_id
        AND edr.external_database_id = ed.external_database_id
        AND ed.name like 'otu%_RSRC'
       GROUP BY (abundance.protocol_app_node_id, abundance.category, abundance.taxon_level, abundance.term, pan.name, ed.name)
       ORDER BY dataset_name, pan_name
      ]]>
    </sql>
    <sql>
      <![CDATA[
        CREATE UNIQUE INDEX TaxAbund_panId_Term&1
          ON TaxonAbundance&1 (protocol_app_node_id, category, term)

      ]]>
    </sql>
  </tuningTable>
-->

  <tuningTable name="ProjectTaxon" prefixEnabled="true">
    <comment>map taxon names onto project_ids. to be used by the apidb.project_id function</comment>
    <externalDependency name="dots.ExternalNaSequence"/>
    <externalDependency name="sres.TaxonName"/>
    <externalDependency name="core.ProjectInfo"/>
    <externalDependency name="apidb.Organism"/>
    <sql>
      <![CDATA[
        CREATE TABLE &prefixProjectTaxon&1 AS
        WITH
            local_taxon -- a taxon found in this instance, either in dots.ExternalNaSequence or in apidb.Organism
                AS (  SELECT distinct tn.name as taxon,
                          substr((tn.name), 1, position(' ' IN tn.name||' ') - 1) as first_word,
                          pi.name as project_id
                      FROM dots.ExternalNaSequence ens, sres.TaxonName tn, core.ProjectInfo pi
                      WHERE ens.taxon_id = tn.taxon_id
                              and ((tn.name not like 'Bodo %' and tn.name not like 'Drosophila %')
                                    OR tn.name_class = 'scientific name')
                              and ens.row_project_id = pi.project_id
                          -- get names from apidb.Organism.family_name_for_files
                          --   (may not be necessary)
                      UNION
                      SELECT family_name_for_files as taxon,
                          substr((family_name_for_files), 1, position(' ' IN family_name_for_files||' ') - 1) as first_word,
                          project_name as project_id
                      FROM apidb.Organism
                      WHERE family_name_for_files in (select name from sres.TaxonName)
            ),
            mononym -- a taxon name that's the first word of a local taxon
                AS (SELECT distinct lower(lt.first_word) as taxon, lt.project_id
                    FROM local_taxon lt, sres.TaxonName tn
                    WHERE lt.first_word = tn.name
                          -- and tn.name_class = 'scientific name'
                    ),
            full_name -- the full name of a local taxon whose first name is not a taxon
                AS (SELECT distinct lower(lt.taxon) as taxon, lt.project_id
                    FROM local_taxon lt, sres.TaxonName tn
                    WHERE lt.taxon = tn.name
                            -- and tn.name_class = 'scientific name'
                            and lower(lt.first_word) not in (select taxon from mononym))
        SELECT * FROM mononym
        UNION
        SELECT * FROM full_name
        UNION
        SELECT 'hypocrea', 'FungiDB'
        UNION
        SELECT 'perkinsiella-like_sp._plo/afsm11', 'TriTrypDB'
        UNION
        SELECT 'perkinsiella-like_sp._plo/afsm2', 'TriTrypDB'
        UNION
        SELECT 'perkinsiella-like_sp._plo/amopi', 'TriTrypDB'
        UNION
        SELECT 'perkinsiella-like_sp._plo/asl1', 'TriTrypDB'
        UNION
        SELECT 'perkinsiella-like_sp._plo/de11d', 'TriTrypDB'
        UNION
        SELECT 'perkinsiella-like_sp._plo/de4a', 'TriTrypDB'
        UNION
        SELECT 'perkinsiella-like_sp._plo/frs/i', 'TriTrypDB'
        UNION
        SELECT 'perkinsiella-like_sp._plo/gd-d1-1', 'TriTrypDB'
        UNION
        SELECT 'perkinsiella-like_sp._plo/gd-d1-2', 'TriTrypDB'
        UNION
        SELECT 'perkinsiella-like_sp._plo/gd-d1-3', 'TriTrypDB'
        UNION
        SELECT 'perkinsiella-like_sp._plo/gillnor1/i', 'TriTrypDB'
        UNION
        SELECT 'perkinsiella-like_sp._plo/gillnor2/i', 'TriTrypDB'
        UNION
        SELECT 'perkinsiella-like_sp._plo/gillrich3/i', 'TriTrypDB'
        UNION
        SELECT 'perkinsiella-like_sp._plo/lithon', 'TriTrypDB'
        UNION
        SELECT 'perkinsiella-like_sp._plo/net12afl/i', 'TriTrypDB'
        UNION
        SELECT 'perkinsiella-like_sp._plo/netc1/i', 'TriTrypDB'
        UNION
        SELECT 'perkinsiella-like_sp._plo/netc2/i', 'TriTrypDB'
        UNION
        SELECT 'perkinsiella-like_sp._plo/neth2t3/i', 'TriTrypDB'
        UNION
        SELECT 'perkinsiella-like_sp._plo/np251002/i', 'TriTrypDB'
        UNION
        SELECT 'perkinsiella-like_sp._plo/nrss/ii', 'TriTrypDB'
        UNION
        SELECT 'perkinsiella-like_sp._plo/pal2', 'TriTrypDB'
        UNION
        SELECT 'perkinsiella-like_sp._plo/pao27/i', 'TriTrypDB'
        UNION
        SELECT 'perkinsiella-like_sp._plo/rp', 'TriTrypDB'
        UNION
        SELECT 'perkinsiella-like_sp._plo/sed5a/i', 'TriTrypDB'
        UNION
        SELECT 'perkinsiella-like_sp._plo/sedc1/i', 'TriTrypDB'
        UNION
        SELECT 'perkinsiella-like_sp._plo/sedcb1/i', 'TriTrypDB'
        UNION
        SELECT 'perkinsiella-like_sp._plo/sedct1/i', 'TriTrypDB'
        UNION
        SELECT 'perkinsiella-like_sp._plo/sedmh1/i', 'TriTrypDB'
        UNION
        SELECT 'perkinsiella-like_sp._plo/sedst1/i', 'TriTrypDB'
        UNION
        SELECT 'perkinsiella-like_sp._plo/sm53', 'TriTrypDB'
        UNION
        SELECT 'perkinsiella-like_sp._plo/sm68', 'TriTrypDB'
        UNION
        SELECT 'perkinsiella-like_sp._plo/st4n', 'TriTrypDB'
        UNION
        SELECT 'perkinsiella-like_sp._plo/st8v/i', 'TriTrypDB'
        UNION
        SELECT 'perkinsiella-like_sp._plo/su03', 'TriTrypDB'
        UNION
        SELECT 'perkinsiella-like_sp._plo/su4', 'TriTrypDB'
        UNION
        SELECT 'perkinsiella-like_sp._plo/tg1162', 'TriTrypDB'
        UNION
        SELECT 'perkinsiella-like_sp._plo/tg1267', 'TriTrypDB'
        UNION
        SELECT 'perkinsiella-like_sp._plo/tun1/i', 'TriTrypDB'
        UNION
        SELECT 'perkinsiella-like_sp._plo/wt2708/i', 'TriTrypDB'
        UNION
        SELECT 'perkinsiella-like_sp._plo/wtuts/i', 'TriTrypDB'
        UNION
        SELECT 'plo_of_paramoeba_invadens_ags-2013', 'TriTrypDB'
        UNION
        SELECT 'soil_flagellate_and31', 'TriTrypDB'
        UNION
        SELECT 'kinetoplastid_flagellate_lfs2', 'TriTrypDB'
        UNION
        SELECT 'cryptaulaxoides-like_sp._tcs-2003', 'TriTrypDB'
        ORDER BY 2, 1
      ]]>
    </sql>
    <sql>
      <![CDATA[
        update &prefixProjectTaxon&1
        set taxon = replace(taxon, '''', '')
        where taxon like '%''%'
      ]]>
    </sql>
    <sql>
      <![CDATA[
        create unique index data_load_prjct_err&1 on &prefixProjectTaxon&1 (taxon)
      ]]>
    </sql>
    <sql>
      <![CDATA[
        create unique index projtax_ix&1 on &prefixProjectTaxon&1 (taxon, project_id)
      ]]>
    </sql>
  </tuningTable>


  <tuningTable name="DatasetPresenter" alwaysUpdate="true">
    <comment> Data for a dataset. Used widely in the model, and by GBrowse.</comment>
    <externalDependency name="core.ProjectInfo"/>
    <externalDependency name="sres.ExternalDatabase"/>
    <ancillaryTable name="DatasetContact"/>
    <ancillaryTable name="DatasetProperty"/>
    <ancillaryTable name="DatasetHyperLink"/>
    <ancillaryTable name="DatasetPublication"/>
    <ancillaryTable name="DatasetModelRef"/>
    <ancillaryTable name="DatasourceModelRef"/>
    <ancillaryTable name="DatasetDatasource"/>
    <ancillaryTable name="DatasetHistory"/>
    <program commandLine="buildDatasetPresentersTT"/>
  </tuningTable>

  <tuningTable name="AssociatedDataset" alwaysUpdate="true">
    <comment>datasets shared with other projects</comment>
    <internalDependency name="DatasetPresenter"/>
    <program commandLine="buildAssociatedDatasetTT"/>
  </tuningTable>

  <tuningTable name="EupathBuildDates" alwaysUpdate="true">
    <program commandLine="buildEupathBuildDatesTT"/>
  </tuningTable>

  <tuningTable name="DatasetDetail" alwaysUpdate="true">
    <comment> Stores text associated with each dataset. Used by dataset queries.
      </comment>
    <internalDependency name="DatasetPresenter"/>

    <!-- TODO:  add back category here -->
    <sql>
      <![CDATA[
        CREATE TABLE DatasetDetail&1 AS
        SELECT dataset_presenter_id,
          name  || ' ' || usage || ' ' ||
          caveat || ' ' || acknowledgement 
          ||' ' || summary || ' ' || description || ' ' || contact || ' ' ||
          institution || ' ' || pubmed_id || ' ' || citation as search_string
        FROM (
          SELECT
            sub.dataset_presenter_id as dataset_presenter_id,
            sub.name as name,
            --sub.category as category,
            sub.usage as usage,
            sub.caveat as caveat,
            sub.acknowledgement as acknowledgement,
            --sub.type as type,
            --sub.subtype as subtype,
            sub.contact,
            sub.institution,
            sub.pubmed_id,
            sub.citation,
            dp.summary,
            dp.description
          FROM DatasetPresenter dp,
          (
            SELECT DISTINCT
              dp.dataset_presenter_id as dataset_presenter_id,
              dp.display_name as name,
              --dp.display_category as category,
              dp.usage as usage,
              dp.caveat as caveat,
              dp.acknowledgement as acknowledgement,
              --dp.type as type,
              --dp.subtype as subtype,
              dc.name as contact,
              dc.affiliation as institution,
              string_agg(dpub.pmid, ' ' ORDER BY dpub.pmid) as pubmed_id,
              -- CHECK AND FIX - regexp_like ISSUE
              --string_agg(CASE WHEN REGEXP_LIKE(dpub.citation, '[[:digit:]]{4};')
              --             THEN substr(citation, 1, regexp_instr(citation, '[[:digit:]]{4};' ) - 1)
              --             ELSE dpub.citation
              --        END , '  ' ORDER BY dpub.citation) as citation
             string_agg(dpub.citation, ' '  ORDER BY dpub.citation) as citation
            FROM DatasetPresenter dp, DatasetContact dc,
                 DatasetPublication dpub
            WHERE dp.dataset_presenter_id = dc.dataset_presenter_id
              AND dp.dataset_presenter_id = dpub.dataset_presenter_id
              AND dc.is_primary_contact = true
            GROUP by dp.dataset_presenter_id, dp.display_name,
                     dp.usage,dp.caveat,dp.acknowledgement,dc.name,
                     dc.affiliation
          ) sub
          WHERE dp.dataset_presenter_id = sub.dataset_presenter_id
        ) t
      ]]>
    </sql>
<!--    <sql>-->
<!--      <![CDATA[-->
<!--          CREATE INDEX DATASET_DETAIL_IDX&1 ON DATASETDETAIL&1 (search_string)-->
<!--          INDEXTYPE IS CTXSYS.CONTEXT-->
<!--      ]]>-->
<!--    </sql>-->
  </tuningTable>

  <tuningTable name="ExternalDbDatasetPresenter">
    <comment>
      A materialization of the oft-computed join of sres.externalDatabaseRelease,
      sres.externalDatabase, and DatasetPresenter.
    </comment>
    <internalDependency name="DatasetPresenter"/>
    <externalDependency name="sres.ExternalDatabase"/>
    <externalDependency name="sres.ExternalDatabaseRelease"/>
    <sql>
      <![CDATA[
        CREATE TABLE ExternalDbDatasetPresenter&1 AS
        SELECT ed.external_database_id, ed.name AS external_database_name,
               edr.external_database_release_id, SUBSTR(edr.version, 1, 40) AS external_database_version,
               dsp.dataset_presenter_id, dsp.name AS dataset_presenter_name,
               dsp.display_name AS dataset_presenter_display_name
        FROM sres.externalDatabaseRelease edr,  sres.externalDatabase ed, DatasetPresenter dsp
        WHERE ed.external_database_id = edr.external_database_id
          AND (ed.name = dsp.name
               OR ed.name LIKE dsp.dataset_name_pattern)
        ORDER BY ed.name
      ]]>
    </sql>
    <sql>
      <![CDATA[
        create index edd_rlsidix&1
          on ExternalDbDatasetPresenter&1
            (external_database_release_id, external_database_id, external_database_name,
             dataset_presenter_id, dataset_presenter_name, dataset_presenter_display_name)

      ]]>
    </sql>
    <sql>
      <![CDATA[
        create index edd_dsidix&1
          on ExternalDbDatasetPresenter&1
            (dataset_presenter_id, external_database_id, external_database_release_id, 
             external_database_name, dataset_presenter_name, dataset_presenter_display_name)

      ]]>
    </sql>
    <sql>
      <![CDATA[
        create index edd_dsnameix&1
          on ExternalDbDatasetPresenter&1
            (dataset_presenter_name, dataset_presenter_id, external_database_id, 
             external_database_release_id, external_database_name, external_database_version, 
             dataset_presenter_display_name)

      ]]>
    </sql>
  </tuningTable>

<!-- COMMENT FOR NOW, as no InferredParam table; FIX later 
  <tuningTable name="TaxonRelativeAbundance">
    <comment>for the sample record taxon relative abundance table
     </comment>
    <internalDependency name="InferredParams"/>
    <externalDependency name="results.LineageAbundance"/>
    <externalDependency name="results.LineageTaxon"/>
    <externalDependency name="sres.Taxon"/>
    <sql>
      <![CDATA[
        CREATE TABLE TaxonRelativeAbundance&1
            (name, protocol_app_node_id, relative_abundance,
             absolute_abundance, ncbi_tax_id, lineage, kingdom, phylum, class,
             rank_order, family, genus, species
             )
        AS SELECT
           sp.name,
           la.protocol_app_node_id,
           la.relative_abundance,
           la.raw_count as absolute_abundance,
           st.ncbi_tax_id,
           la.lineage,
           cast(regexp_replace(la.lineage, '^([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?$', '\1') as VARCHAR(20)) as kingdom,
           cast(regexp_replace(la.lineage, '^([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?$', '\2') as VARCHAR(50)) as phylum,
           cast(regexp_replace(la.lineage, '^([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?$', '\3') as VARCHAR(50)) as class,
           cast(regexp_replace(la.lineage, '^([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?$', '\4') as VARCHAR(50)) as rank_order,
           cast(regexp_replace(la.lineage, '^([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?$', '\5') as VARCHAR(100)) as family,
           cast(regexp_replace(la.lineage, '^([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?$', '\6') as VARCHAR(100)) as genus,
           cast(regexp_replace(la.lineage, '^([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?([^;]+)?;?$', '\7') as VARCHAR(100)) as species
        FROM
          apidbtuning.SampleProcess sp,
          results.LineageAbundance la
          LEFT JOIN results.LineageTaxon lt ON la.lineage = lt.lineage
          LEFT JOIN sres.Taxon st ON lt.taxon_id = st.taxon_id
        WHERE
          la.protocol_app_node_id = sp.output_pan_id
      ]]>
    </sql>
    <sql>
      <![CDATA[
        CREATE INDEX taxRelAbund_pk&1
          ON TaxonRelativeAbundance&1 (name, lineage)

      ]]>
    </sql>
  </tuningTable>
-->

  <tuningTable name="EdaGeneGraph" alwaysUpdate="true">
    <comment>EDA Graph Config for Gene pages
      </comment>
    <program commandLine="buildEdaGeneGraphTT"/>
  </tuningTable>


  <tuningTable name="PANResults" prefixEnabled="true">
    <comment>Table of protocol app node ids and the name of the result table where they are referenced
    </comment>
    <externalDependency name="apidb.ChrCopyNumber"/>
    <externalDependency name="apidb.CrisprPhenotype"/>
    <externalDependency name="apidb.GeneCopyNumber"/>
    <externalDependency name="apidb.IntronJunction"/>
    <externalDependency name="apidb.MassSpecSummary"/>
    <externalDependency name="apidb.RflpGenotype"/>
    <externalDependency name="apidb.RflpGenotypeNumber"/>
    <externalDependency name="results.CompoundMassSpec"/>
    <externalDependency name="results.EditingEvent"/>
    <externalDependency name="results.FamilyDiffResult"/>
    <externalDependency name="results.FamilyExpression"/>
    <externalDependency name="results.GeneDiffResult"/>
    <externalDependency name="results.GeneExpression"/>
    <externalDependency name="results.GeneSimilarity"/>
    <externalDependency name="results.LineageAbundance"/>
    <externalDependency name="results.NaFeatureDiffResult"/>
    <externalDependency name="results.NaFeatureExpression"/>
    <externalDependency name="results.NaFeatureHostResponse"/>
    <externalDependency name="results.ReporterDiffResult"/>
    <externalDependency name="results.ReporterExpression"/>
    <externalDependency name="results.ReporterIntensity"/>
    <externalDependency name="results.RnaDiffResult"/>
    <externalDependency name="results.RnaExpression"/>
    <externalDependency name="results.SegmentDiffResult"/>
    <externalDependency name="results.SegmentResult"/>
    <externalDependency name="results.SeqVariation"/>
    <externalDependency name="study.ProtocolAppNode"/>
    <sql>
      <![CDATA[
        CREATE TABLE &prefixPANResults&1 AS
        SELECT DISTINCT r.*
        FROM (
          SELECT protocol_app_node_id as pan_id, 'Results::NAFeatureDiffResult' as result_table FROM study.ProtocolAppNode
          WHERE protocol_app_node_id in (select protocol_app_node_id FROM Results.NAFeatureDiffResult)
        UNION
          SELECT protocol_app_node_id, 'Results::ReporterIntensity' as result_table FROM study.ProtocolAppNode
          WHERE protocol_app_node_id in (select protocol_app_node_id FROM Results.ReporterIntensity)
        UNION
          SELECT protocol_app_node_id, 'Results::SegmentResult' as result_table FROM study.ProtocolAppNode
          WHERE protocol_app_node_id in (select protocol_app_node_id FROM Results.SegmentResult)
        UNION
          SELECT protocol_app_node_id, 'Results::CompoundMassSpec' as result_table FROM study.ProtocolAppNode
          WHERE protocol_app_node_id in (select protocol_app_node_id FROM Results.CompoundMassSpec)
        UNION
          SELECT protocol_app_node_id, 'Results::NaFeatureHostResponse' as result_table FROM study.ProtocolAppNode
          WHERE protocol_app_node_id in (select protocol_app_node_id FROM Results.NaFeatureHostResponse)
        UNION
          SELECT protocol_app_node_id, 'ApiDB::ChrCopyNumber' as result_table FROM study.ProtocolAppNode
          WHERE protocol_app_node_id in (select protocol_app_node_id FROM ApiDB.ChrCopyNumber)
        UNION
          SELECT protocol_app_node_id, 'ApiDB::GeneCopyNumber' as result_table FROM study.ProtocolAppNode
          WHERE protocol_app_node_id in (select protocol_app_node_id FROM ApiDB.GeneCopyNumber)
        UNION
          SELECT protocol_app_node_id, 'Results::NAFeatureExpression' as result_table FROM study.ProtocolAppNode
          WHERE protocol_app_node_id in (select protocol_app_node_id FROM Results.NAFeatureExpression)
        UNION
          SELECT protocol_app_node_id, 'Results::EditingEvent' as result_table FROM study.ProtocolAppNode
          WHERE protocol_app_node_id in (select protocol_app_node_id FROM Results.EditingEvent)
        UNION
          SELECT protocol_app_node_id, 'Results::FamilyDiffResult' as result_table FROM study.ProtocolAppNode
          WHERE protocol_app_node_id in (select protocol_app_node_id FROM Results.FamilyDiffResult)
        UNION
          SELECT protocol_app_node_id, 'Results::FamilyExpression' as result_table FROM study.ProtocolAppNode
          WHERE protocol_app_node_id in (select protocol_app_node_id FROM Results.FamilyExpression)
        UNION
          SELECT protocol_app_node_id, 'Results::GeneDiffResult' as result_table FROM study.ProtocolAppNode
          WHERE protocol_app_node_id in (select protocol_app_node_id FROM Results.GeneDiffResult)
        UNION
          SELECT protocol_app_node_id, 'Results::GeneExpression' as result_table FROM study.ProtocolAppNode
          WHERE protocol_app_node_id in (select protocol_app_node_id FROM Results.GeneExpression)
        UNION
          SELECT protocol_app_node_id, 'Results::GeneSimilarity' as result_table FROM study.ProtocolAppNode
          WHERE protocol_app_node_id in (select protocol_app_node_id FROM Results.GeneSimilarity)
        UNION
          SELECT protocol_app_node_id, 'Results::ReporterDiffResult' as result_table FROM study.ProtocolAppNode
          WHERE protocol_app_node_id in (select protocol_app_node_id FROM Results.ReporterDiffResult)
        UNION
          SELECT protocol_app_node_id, 'Results::ReporterExpression' as result_table FROM study.ProtocolAppNode
          WHERE protocol_app_node_id in (select protocol_app_node_id FROM Results.ReporterExpression)
        UNION
          SELECT protocol_app_node_id, 'Results::RnaDiffResult' as result_table FROM study.ProtocolAppNode
          WHERE protocol_app_node_id in (select protocol_app_node_id FROM Results.RnaDiffResult)
        UNION
          SELECT protocol_app_node_id, 'Results::RnaExpression' as result_table FROM study.ProtocolAppNode
          WHERE protocol_app_node_id in (select protocol_app_node_id FROM Results.RnaExpression)
        UNION
          SELECT protocol_app_node_id, 'Results::LineageAbundance' as result_table FROM study.ProtocolAppNode
          WHERE protocol_app_node_id in (select protocol_app_node_id FROM Results.LineageAbundance)
        UNION
          SELECT protocol_app_node_id, 'Results::SegmentDiffResult' as result_table FROM study.ProtocolAppNode
          WHERE protocol_app_node_id in (select protocol_app_node_id FROM Results.SegmentDiffResult)
        UNION
          SELECT protocol_app_node_id, 'Results::SeqVariation' as result_table FROM study.ProtocolAppNode
          WHERE protocol_app_node_id in (select protocol_app_node_id FROM Results.SeqVariation)
        UNION
          SELECT protocol_app_node_id, 'ApiDB::SequenceVariation' as result_table FROM study.ProtocolAppNode
          WHERE protocol_app_node_id in (select protocol_app_node_id FROM study.ProtocolAppNode WHERE name like '% (Sequence Variation)')
        UNION
          SELECT protocol_app_node_id, 'ApiDB::MassSpecSummary' as result_table from study.ProtocolAppNode
          WHERE protocol_app_node_id in (select protocol_app_node_id FROM apidb.MASSSPECSUMMARY)
        UNION
          SELECT protocol_app_node_id, 'ApiDB::IntronJunction' as result_table from study.ProtocolAppNode
          WHERE protocol_app_node_id in (select protocol_app_node_id FROM apidb.IntronJunction)
        UNION
          SELECT protocol_app_node_id, 'ApiDB::RflpGenotype' as result_table from study.ProtocolAppNode
          WHERE protocol_app_node_id in (select protocol_app_node_id FROM apidb.RflpGenotype)
        UNION
          SELECT protocol_app_node_id, 'ApiDB::RflpGenotypeNumber' as result_table from study.ProtocolAppNode
          WHERE protocol_app_node_id in (select protocol_app_node_id FROM apidb.RflpGenotypeNumber)
        UNION
          SELECT protocol_app_node_id, 'ApiDB::CrisprPhenotype' as result_table from study.ProtocolAppNode
          WHERE protocol_app_node_id in (select protocol_app_node_id FROM apidb.crisprphenotype)
        ) r, webready.panextdbrls panExtDbRls
        WHERE r.pan_id = panExtDbRls.pan_id
          AND (panExtDbRls.dataset_name = '&filterValue' or length('&filterValue') = 0)
      ]]>
    </sql>
  </tuningTable>

</tuningConfig>
