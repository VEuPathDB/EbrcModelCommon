<?xml version="1.0" encoding="UTF-8"?>
<tuningConfig>



<!-- TODO:  if this is needed, need to redo the EC_NUMBER query -->
  <tuningTable name="TypeAheadCounts">
    <externalDependency name="dots.DbRefAaFeature"/>
    <externalDependency name="sres.DbRef"/>
    <externalDependency name="dots.AaFeature"/>
    <externalDependency name="sres.ExternalDatabase"/>
    <externalDependency name="sres.ExternalDatabaseRelease"/>
    <externalDependency name="sres.EnzymeClass"/>
    <externalDependency name="dots.AaSequenceEnzymeClass"/>
    <externalDependency name="dots.GoAssociation"/>
    <externalDependency name="dots.GoAssociationInstance"/>
    <externalDependency name="sres.OntologyTerm"/>
    <externalDependency name="core.TableInfo"/>
    <sql>
      <![CDATA[
CREATE TABLE TypeAheadCounts&1 AS
   (SELECT DISTINCT dr.primary_identifier as option_id,
                   count(distinct aaf.aa_sequence_id) AS protein_count
   FROM dots.DbRefAaFeature draf, sres.DbRef dr, dots.aafeature aaf,
        sres.ExternalDatabaseRelease edr, sres.ExternalDatabase ed
   WHERE draf.db_ref_id = dr.db_ref_id
   AND dr.external_database_release_id
       = edr.external_database_release_id
   AND edr.external_database_id = ed.external_database_id
   AND aaf.aa_feature_id = draf.aa_feature_id
   GROUP BY dr.primary_identifier
   )
   UNION
   (SELECT DISTINCT ec.ec_number AS option_id,
          COUNT(DISTINCT asec.aa_sequence_id) AS protein_count
   FROM sres.enzymeClass ec,
        dots.aaSequenceEnzymeClass asec
   WHERE  asec.enzyme_class_id = ec.enzyme_class_id
   GROUP BY ec.ec_number)
   UNION                
   (SELECT DISTINCT gt.source_id AS option_id,
           COUNT(DISTINCT aaf.aa_sequence_id) AS protein_count
    FROM dots.AaFeature aaf,
         dots.GoAssociation ga, sres.OntologyTerm gt,
         dots.GoAssociationInstance gai,core.TableInfo ti
    WHERE aaf.aa_sequence_id = ga.row_id
    AND ga.table_id = ti.table_id
    AND ti.name = 'ExternalAASequence'
    AND ga.go_term_id = gt.ontology_term_id
    AND ga.go_association_id = gai.go_association_id
    GROUP BY gt.source_id)
      ]]>
    </sql>
    <sql>
      <![CDATA[
CREATE INDEX TypeAheadCounts_idx&1 ON TypeAheadCounts&1 (option_id)
      ]]>
    </sql>
  </tuningTable>

  <tuningTable name="DomainAssignment">
    <internalDependency name="SequenceAttributes"/>
    <externalDependency name="apidb.interproresults"/>
    <intermediateTable name="DomainIndex"/>
    <sql>
      <![CDATA[
        create table DomainAssignment&1 as
        select sa.full_id, sa.group_name,
               r.interpro_primary_id as accession,
               r.interpro_desc as description,
               CAST (NULL as NUMERIC) as domain_index,
               sa.aa_sequence_id,
               r.interpro_start_min as start_min,
               r.interpro_end_min as end_max
        from SequenceAttributes sa,  apidb.interproresults r
        where sa.full_id = r.protein_source_id
          and upper(r.interpro_db_name) = 'PFAM'
      ]]>
    </sql>

    <sql>
      <![CDATA[
        create index domain_accession_ix&1
               on DomainAssignment&1 (accession, full_id, group_name)
      ]]>
    </sql>

    <sql>
      <![CDATA[
        create table domainIndex as
        select row_number() OVER () as domain_index, accession
        from (select distinct accession
              from DomainAssignment&1
              order by accession)
      ]]>
    </sql>

    <sql>
      <![CDATA[
        create index domainIdxIdx on DomainIndex(accession, domain_index)
      ]]>
    </sql>

    <sql>
      <![CDATA[
        update DomainAssignment&1 da
        set domain_index = (select domain_index
                            from DomainIndex
                            where accession = da.accession)
      ]]>
    </sql>

    <sql>
      <![CDATA[
        create index domain_ix_ix&1
               on DomainAssignment&1 (domain_index, accession, full_id)
      ]]>
    </sql>

    <sql>
      <![CDATA[
        create index domain_group_ix&1
               on DomainAssignment&1 (group_name, accession, full_id)
      ]]>
    </sql>

    <sql>
      <![CDATA[
        create index domain_seq_ix&1
               on DomainAssignment&1 (aa_sequence_id, accession, full_id, group_name)
      ]]>
    </sql>

  </tuningTable>



</tuningConfig>
