<wdkModel>

  <constant name="datasetRecordDisplayName" includeProjects="ClinEpiDB">Study</constant>
  <constant name="datasetRecordDisplayNamePlural" includeProjects="ClinEpiDB">Studies</constant>

  <constant name="datasetRecordDisplayName" excludeProjects="ClinEpiDB">Data Set</constant>
  <constant name="datasetRecordDisplayNamePlural" excludeProjects="ClinEpiDB">Data Sets</constant>

  <recordClassSet name="DatasetRecordClasses">


<!-- ============== a class with only one member.  the primary key is always 111 ===========  -->

   <recordClass name="DatasetReleaseNotes" urlName="dataset-release-notes" displayName="Data Set Release Notes">
      <primaryKey aliasPluginClassName="org.gusdb.wdk.model.record.GenericRecordPrimaryKeyAliasPlugin">
        <columnRef>release_notes_id</columnRef>
      </primaryKey>

      <idAttribute name="primary_key" displayName="Release Notes ID">
        <text>
          <![CDATA[
            $$release_notes_id$$
          ]]>
        </text>
      </idAttribute>

      <table name="ReleaseNotes"
             displayName="Dataset Release Notes"
             queryRef="DatasetReleaseNotesTables.ReleaseNotes">
        <columnAttribute name="build_number" displayName="VEuPathDB Build #"/>
        <columnAttribute name="release_date" displayName="Release Date"/>
        <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
        <columnAttribute name="dataset_name"  inReportMaker="false" internal="true"/>
        <columnAttribute name="note" displayName="Notes"/>
      </table>

    </recordClass>

<!-- ============== Internal class for tracking datasets from previous releases ===========  -->

   <recordClass name="LegacyDataset" urlName="legacy-dataset" displayName="Legacy Dataset" excludeProjects="MicrobiomeDB,ClinEpiDB,EuPathDB">
      <primaryKey aliasPluginClassName="org.gusdb.wdk.model.record.GenericRecordPrimaryKeyAliasPlugin">
        <columnRef>dataset_presenter_id</columnRef>
        <columnRef>dataset_presenter_name</columnRef>
        <columnRef>project_name</columnRef>
      </primaryKey>

      <idAttribute name="primary_key" displayName="Dataset Name">
        <text>
          <![CDATA[
            $$dataset_presenter_id$$
          ]]>
        </text>
      </idAttribute>
      <reporter name="json"  displayName="json: choose from columns and/or tables" scopes=""
                implementation="org.gusdb.wdk.model.report.reporter.JSONReporter">
      </reporter>

      <attributeQueryRef ref="LegacyDatasetAttributes.DatasetName">
      </attributeQueryRef>


    </recordClass>


<!-- ======================================= DATA SETS =========================================================== -->

    <!-- This recordClass shows as "Study" in ClinEpi record page with some client rendering magic, since includeProjects cannot be used  -->
   <recordClass name="DatasetRecordClass" displayName="%%datasetRecordDisplayName%%" displayNamePlural="%%datasetRecordDisplayNamePlural%%" urlName="dataset" useBasket="false" >
           <!-- description="A Data Set describes the information we acquired from a data provider. For some data sets we process the information to expose the analyzed result in our site (searches, GBrowse tracks etc)." -->

     <testParamValues >
       <paramValue name="dataset_id">1</paramValue>
     </testParamValues>

      <!-- primary key definition
           NOTE:  the name here is from apidbtuning.DatasetPresenter NOT apidb.datasource
      -->

      <primaryKey aliasQueryRef="DatasetAttributes.DatasetAlias">
          <columnRef>dataset_id</columnRef>
      </primaryKey>

      <idAttribute name="primary_key" displayName="Data Set" excludeProjects="MicrobiomeDB,ClinEpiDB"
                   help="Click a data set to go to the full data set record">
          <text>
              <![CDATA[ $$display_name$$ ]]>
          </text>
      </idAttribute>

      <idAttribute name="primary_key" displayName="Study" includeProjects="MicrobiomeDB,ClinEpiDB"
                   help="Click a study to go to the full study record">
          <text>
              <![CDATA[ $$display_name$$ ]]>
          </text>
      </idAttribute>

      <!-- =============================================================== -->
      <!--   Reporters -->
      <!-- =============================================================== -->

          <reporter name="attributesTabular" displayName="Summary - tab delimited" scopes="results"
                    implementation="org.gusdb.wdk.model.report.reporter.AttributesTabularReporter">
             <property name="page_size">500</property>
          </reporter>
          <reporter name="tableTabular" displayName="%%tableReporterDisplayName%%" scopes="results" excludeProjects="EuPathDB"
                    implementation="org.gusdb.wdk.model.report.reporter.TableTabularReporter">
             <property name="page_size">1000000</property>           <!-- huge page size to force no paging  -->
          </reporter>

          <reporter name="fullRecord" displayName="%%fullReporterDisplayName%%" scopes="record"
                    implementation="org.gusdb.wdk.model.report.reporter.FullRecordReporter">
          </reporter>

          <reporter name="xml"  displayName="XML: choose from columns and/or tables" scopes=""
                   implementation="org.gusdb.wdk.model.report.reporter.XMLReporter">
          </reporter>
          <reporter name="json"  displayName="json: choose from columns and/or tables" scopes=""
                    implementation="org.gusdb.wdk.model.report.reporter.JSONReporter">
          </reporter>

      <!-- =============================================================== -->
      <!--   Filters -->
      <!-- =============================================================== -->


      <!-- =================================================================== -->
      <!--  Text Attributes  ++++++++-->
      <!-- =================================================================== -->


       <attributeQueryRef ref="DatasetAttributes.Organisms"  excludeProjects="MicrobiomeDB,ClinEpiDB">
         <columnAttribute  name="organism_prefix" displayName="Organism(s) (source or reference)"
                          help="The 'source' is the organism used to generate the samples that were analyzed to produce this dataset. The 'reference' is the genome that the data were aligned to. For functional datasets, the source may differ from the reference."/>
       </attributeQueryRef>

       <attributeQueryRef ref="DatasetAttributes.Projects"  includeProjects="EuPathDB">
         <columnAttribute  name="project_id" displayName="VEuPathDB Project"/>
       </attributeQueryRef>

       <attributeQueryRef ref="DatasetAttributes.EdaStudyMapping"  includeProjects="MicrobiomeDB,ClinEpiDB,VectorBase">
         <columnAttribute  name="eda_study_id" displayName="Eda study ID"/>
       </attributeQueryRef>

       <attributeQueryRef ref="DatasetAttributes.NewCategory" excludeProjects="MicrobiomeDB,ClinEpiDB">
         <columnAttribute name="newcategory" displayName="Category" inReportMaker="false"
                          help= "Datasets are assigned to categories based on the biological attributes of the data." />
       </attributeQueryRef>

       <attributeQueryRef ref="DatasetAttributes.DatasetDisplayName">
         <columnAttribute name="display_name" internal="true" displayName="Dataset Name"/>
       </attributeQueryRef>

        <attributeQueryRef ref="DatasetAttributes.GenomicsDatasetAttributes" excludeProjects="MicrobiomeDB,ClinEpiDB">
         <columnAttribute name="megabase_pairs" displayName="Megabase pairs"/>
         <columnAttribute name="genecount" displayName="Genes" help="Total gene count" align="right" />
       </attributeQueryRef>

       <attributeQueryRef ref="DatasetAttributes.GenomicsStudyAttributes" excludeProjects="MicrobiomeDB,ClinEpiDB">
        <columnAttribute name="is_public" displayName="Is public"/>
       </attributeQueryRef>

        <attributeQueryRef ref="DatasetAttributes.LatestVersion" excludeProjects="MicrobiomeDB,ClinEpiDB">
         <columnAttribute name="genome_version" displayName="Genome Version"/>
         <columnAttribute name="annotation_version" displayName="Annotation Version"/>
         <columnAttribute name="functional_annotation_version" displayName="Functional Annotation Version"/>
       </attributeQueryRef>
<!--
       <attributeQueryRef ref="DatasetAttributes.DatasetDigest" includeProjects="MicrobiomeDB,ClinEpiDB,VectorBase">
         <columnAttribute name="dataset_sha1_digest" internal="true"/>
         <columnAttribute name="dataset_display_name" internal="true"/>
         <linkAttribute name="bulk_download_url" displayName="Download" inReportMaker="false">
              <displayText>
                <![CDATA[ <i class="fa fa-download"></i> ]]>
              </displayText>
              <url>
                <![CDATA[ @WEBAPP_BASE_URL@/downloads/release-%%buildNumber%%/$$dataset_sha1_digest$$ ]]>
              </url>
         </linkAttribute>
       </attributeQueryRef>
-->
       <attributeQueryRef ref="DatasetAttributes.ClinepiStudyAttributes" includeProjects="MicrobiomeDB,ClinEpiDB">
         <columnAttribute name="project_availability" internal="true"/>
         <columnAttribute name="is_public" internal="true"/>
         <columnAttribute name="is_prerelease" type="number"/>
         <columnAttribute name="study_access" displayName="Data accessibility"
           help="Some studies require that the user requests approval to access certain functionality 
(they will be prompted when attempting the action): 
if 'private', to explore the data, analyze it and download; if 'controlled' or 'protected', just to download. 
In controlled studies the user will be allowed to access the data automatically upon request submission,
while in protected and private studies there will be human intervention in the decision."/>
         <columnAttribute name="days_for_approval"/>
         <columnAttribute name="policy_url" internal="true"/>
         <columnAttribute name="card_headline" internal="true"/>
         <columnAttribute name="card_points" internal="true"/>
         <columnAttribute name="card_questions" displayName="Searches"/>
         <columnAttribute name="request_protection_level" internal="true"/>
         <columnAttribute name="request_access_fields" internal="true"/>
         <columnAttribute name="request_email" internal="true"/>
         <columnAttribute name="request_email_bcc" internal="true"/>
         <columnAttribute name="request_email_body" internal="true"/>
         <columnAttribute name="request_needs_approval" internal="true"/>
         <columnAttribute name="request_email_body_manager" internal="true"/>
         <columnAttribute name="request_email_body_requester" internal="true"/>
         <columnAttribute name="custom_download_tab"/>
         <columnAttribute name="custom_download_ack"/>
         <linkAttribute name="analyze" displayName="Explore &amp; analyze" sortable="false" includeProjects="ClinEpiDB">
           <displayText>
             <![CDATA[
               <div style="text-align: center">
                 <i style="color: black; font-size: 2em;" class="ebrc-icon-edaIcon"></i>
               </div>
             ]]>
           </displayText>
           <url>
             @WEBAPP_BASE_URL@/workspace/analyses/$$dataset_id$$/new
           </url>
         </linkAttribute>
         <linkAttribute name="bulk_download_url" displayName="Download" inReportMaker="false">
           <displayText>
             <![CDATA[ <i class="fa fa-download"></i> ]]>
           </displayText>
           <url>
             @WEBAPP_BASE_URL@/workspace/analyses/$$dataset_id$$/new/download
           </url>
         </linkAttribute>
       </attributeQueryRef>


       <attributeQueryRef ref="DatasetAttributes.MicrobiomeStudyAttributes" includeProjects="MicrobiomeDB">
         <columnAttribute name="study_categories" displayName="Category"/>
       </attributeQueryRef>



       <attributeQueryRef ref="DatasetAttributes.StudyCharacteristic" includeProjects="ClinEpiDB">
         <columnAttribute name="disease" displayName="Disease"/>
         <columnAttribute name="sex" displayName="Sex"/>
         <columnAttribute name="Sample_Type" displayName="Sample type"/>
         <!-- columnAttribute name="Participant_Type" displayName="Population included"/ -->
         <columnAttribute name="Study_Type" displayName="Investigation type"/>
         <columnAttribute name="Study_Design" displayName="Study design"/>
         <columnAttribute name="Country" displayName="Country"/>
         <columnAttribute name="Years" displayName="Years"/>
         <columnAttribute name="Variable_count" displayName="Variables" type="number"/>
         <columnAttribute name="HH_count" displayName="Households" type="number"/>
         <columnAttribute name="Part_count" displayName="Participants" type="number"/>
         <columnAttribute name="Obser_count" displayName="Participant repeated measures" type="number"/>
         <columnAttribute name="Samp_count" displayName="Samples" type="number"/>
         <columnAttribute name="AdditionalData" displayName="Additional data"/>
         <columnAttribute name="Age" displayName="Age"/>
         <columnAttribute name="WHO" displayName="WHO indicator subdomain"/>
         <columnAttribute name="ProjectName" displayName="Project name"/>
       </attributeQueryRef>

      <attributeQueryRef ref="DatasetAttributes.StudyReqStats" includeProjects="ClinEpiDB">
        <columnAttribute name="total" displayName="Total requests" />
         <columnAttribute name="approved" displayName="Approved requests" />
         <columnAttribute name="percent_approved" displayName="Percent approved"/>
	 <columnAttribute name="total_number"  type="number" />
         <columnAttribute name="approved_number"  type="number"/>
         <columnAttribute name="percent_approved_number"  type="number"/>
       </attributeQueryRef>

       <attributeQueryRef ref="DatasetAttributes.All">
         <columnAttribute name="dataset_name" internal="true" displayName="Data Set Name" help="Name of the dataset."/>
         <columnAttribute name="dataset_name_pattern" internal="true" inReportMaker="false"/>
<!--         <columnAttribute name="display_name" internal="true" displayName="Dataset Name" removable="false"/> -->
         <columnAttribute name="short_display_name" internal="true"/>
         <columnAttribute name="version" displayName="Data Set Version"  internal="true" includeProjects="MicrobiomeDB,EuPathDB"/>
          <columnAttribute name="version" displayName="Data Set Version" help="The data set provider's version number or publication date, from the site the data was acquired. In the rare case neither is available, the download date." excludeProjects="MicrobiomeDB,ClinEpiDB,EuPathDB"/>
         <columnAttribute name="description" displayName="Description" sortable="false"/>
         <columnAttribute name="protocol" internal="true"/>
         <columnAttribute name="usage" displayName="Usage" internal="true"/>
         <columnAttribute name="is_species_scope" displayName="Is Species Scope" internal="true"/>
         <columnAttribute name="build_number_introduced" displayName="Build Number Introduced" type="number"/>
         <columnAttribute name="type" displayName="Type" internal="true"/>
         <columnAttribute name="eupath_release" displayName="Release # and date" 
                          help="The VEuPathDB release number and date that the dataset first appeared in VEuPathDB. "/>
         <columnAttribute name="summary" displayName="Summary" sortable="false"
                          help= "A short description of the dataset."/>
         <columnAttribute name="pmids" displayName="References" sortable="false" excludeProjects="ClinEpiDB" help="Links related to the dataset including PubMed for scientific papers and DOIs for other resources, e.g, book chapters. Other DOI links are linkouts to databases where raw data has been deposited, specially frequent in the case of population abundance data."/>
         <columnAttribute name="pmids_download" displayName="Publications" sortable="false"  excludeProjects="ClinEpiDB" help="PubMed links related to the dataset."/>
       </attributeQueryRef>

      <attributeQueryRef ref="DatasetAttributes.OwnerVisibility" excludeProjects="MicrobiomeDB,ClinEpiDB">
         <columnAttribute name="owner" displayName="Owner" />
         <columnAttribute name="community" displayName="Community"/>
       </attributeQueryRef>


       <attributeQueryRef ref="DatasetAttributes.CavAckRP" excludeProjects="ClinEpiDB">
         <columnAttribute name="caveat" displayName="Caveat" internal="true"/>
         <columnAttribute name="acknowledgement" displayName="Acknowledgement" internal="true"/>
         <columnAttribute name="release_policy" displayName="Release Policy" internal="true" includeProjects="MicrobiomeDB"/>
         <columnAttribute name="release_policy" displayName="Release Policy" excludeProjects="MicrobiomeDB,ClinEpiDB"
                          help= "A request from the data provider stipulating the proper use of unpublished data. "  />
       </attributeQueryRef>

      <attributeQueryRef ref="DatasetAttributes.genecounts" excludeProjects="MicrobiomeDB,ClinEpiDB">
         <columnAttribute name="gene_count" displayName="Genes" help="Total gene count" align="right" />
      </attributeQueryRef>

       <attributeQueryRef ref="DatasetAttributes.Contacts">
         <columnAttribute name="contact" displayName="Contact" 
                          help="The person or organization that serves as a source of information concerning this dataset."/>
         <columnAttribute name="institution" displayName="Contact institution" 
                          help="The institution where the Contact is located. "/>
         <columnAttribute name="email" internal="true"/>
         <columnAttribute name="short_attribution" displayName="Short Attribution" internal="true"/>
       </attributeQueryRef>

       <attributeQueryRef ref="DatasetAttributes.inApollo" excludeProjects="EuPathDB,MicrobiomeDB,ClinEpiDB">
         <columnAttribute name="in_apollo" displayName="Apollo" help="This genome is available in Apollo for community annotation" align="right" />
       </attributeQueryRef>

      <!--   <attributesList summary="organism_prefix,version,eupath_release,build_number_introduced,newcategory,pmids,summary,contact" -->
        <attributesList summary="organism_prefix,version,eupath_release,newcategory,pmids,summary,contact,genome_version,annotation_version,functional_annotation_version,megabase_pairs,in_apollo"
                        excludeProjects="MicrobiomeDB,ClinEpiDB,EuPathDB"/>

        <attributesList summary="organism_prefix,project_id,eupath_release,newcategory,pmids,summary,contact,genome_version,annotation_version,functional_annotation_version,megabase_pairs"
                        includeProjects="EuPathDB"/>

      <!--  <attributesList summary="disease,study_access,card_questions,eupath_release,total,approved,percent_approved"-->
        <attributesList summary="analyze,disease,Study_Type,Study_Design,Part_count,Country,Years,study_access"
			includeProjects="ClinEpiDB"/>

	<attributesList summary="study_categories,summary,eupath_release"
			includeProjects="MicrobiomeDB"/>


	<!-- to add a column to link somewhere, for example pubmed publication
             <textAttribute name="" displayName="" help="">
           <text>
                 <![CDATA[
                <a href="bla">linkName</a>
                ]]>
            </text>
         </textAttribute>

OR if the linkName and or URL require access to other attributes....also how to define the same column differently for downloads vs results page

            <columnAttribute name="uniprot_id" internal="true" displayName="UniProt ID" inReportMaker="true" attributeCategory="ids"/>
            <columnAttribute name="uniprot_id_internal"  internal="true" inReportMaker="false" />
            <linkAttribute name="uniprot_link" displayName="UniProt ID" inReportMaker="false" sortable="false" attributeCategory="ids">
                <displayText>
                    <![CDATA[$$uniprot_id$$]]>
                </displayText>
                <url>
                    <![CDATA[http://www.uniprot.org/uniprot/?query=$$uniprot_id_internal$$]]>
                </url>
            </linkAttribute>

-->




  <!-- =================================================================================== -->
  <!-- TABLES ++++++++-->
  <!-- ================================================================================= -->


      <table name="DatasetAlias"
	     excludeProjects="MicrobiomeDB,ClinEpiDB"
	     displayName="Dataset Alias"
	     queryRef="DatasetAttributes.DatasetAlias" inReportMaker="false">
        <columnAttribute name="dataset_id"/>
        <columnAttribute name="old_dataset_id"/>
    </table>



     <!-- =================================================================== -->
     <!-- Example Graphs ++++++++-->
     <!-- =================================================================== -->

      <table name="ExampleGraphs"
	     excludeProjects="EuPathDB,ClinEpiDB,MicrobiomeDB"
	     displayName="Example Graphs"
	     queryRef="DatasetTables.ExampleGraphs" inReportMaker="false">
  <textAttribute name="thumbnail" displayName="Preview">
              <text>
                   <![CDATA[
                   <img src="/cgi-bin/dataPlotter.pl?project_id=@PROJECT_ID@&id=$$default_graph_id$$&type=$$module$$&fmt=png&template=$$template$$&h=35&w=70&compact=1&datasetId=$$dataset_id$$&default=1"/>
                    ]]>
              </text>
            </textAttribute>
            <columnAttribute internal="true" displayName="source_id" name="source_id"/>
            <columnAttribute internal="true" displayName="project_id" name="project_id"/>
            <columnAttribute internal="true" displayName="graph_ids" name="graph_ids"/>
            <columnAttribute internal="true" displayName="module" name="module"/>
            <columnAttribute internal="true" displayName="mainOpen" name="mainOpen"/>
            <columnAttribute internal="true" displayName="dataOpen" name="dataOpen"/>
            <columnAttribute displayName="Name" name="display_name"/>
            <columnAttribute internal="true" displayName="description" name="description"/>
            <columnAttribute internal="true" displayName="x_axis" name="x_axis"/>
            <columnAttribute internal="true" displayName="y_axis" name="y_axis"/>
            <columnAttribute internal="true" displayName="has_graph_data" name="has_graph_data"/>
            <columnAttribute internal="true" displayName="has_meta_data" name="has_meta_data"/>
            <columnAttribute internal="true" displayName="meta_data_categories" name="meta_data_categories"/>
            <columnAttribute internal="true" displayName="dataset_name" name="dataset_name"/>
            <columnAttribute internal="true" displayName="dataset_id" name="dataset_id"/>
            <columnAttribute internal="true" displayName="is_graph_custom" name="is_graph_custom"/>
       <!--     <columnAttribute displayName="Summary" name="summary"/>
            <columnAttribute displayName="Attribution" name="short_attribution"/>
       -->
            <columnAttribute displayName="Assay Type" name="assay_type"/>
            <columnAttribute internal="true"  displayName="Template" name="template"/>
            <columnAttribute internal="true" displayName="DefaultGraphId" name="default_graph_id"/>
         <propertyList name="excludeFromDumper"><value>true</value></propertyList>
      </table>







        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- Contacts -->
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <table name="Contacts"
               displayName="Principal Investigator and Collaborators"
               queryRef="DatasetTables.Contacts">
            <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="dataset_name"  inReportMaker="false" internal="true"/>
            <columnAttribute name="contact_name" displayName="Investigator"/>
            <columnAttribute name="affiliation" displayName="Affiliation"/>
        </table>



        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- Study Characteristic -->
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

        <!-- NOTE: We're reusing the attribute query here -->
        <table name="StudyCharacteristicTable" includeProjects="ClinEpiDB"
               displayName="Study Characteristics"
               queryRef="DatasetAttributes.StudyCharacteristic">
            <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
<!--            <columnAttribute name="dataset_name"  inReportMaker="false" internal="true"/> -->
            <columnAttribute name="disease" displayName="Disease" sortable="false"/>
            <columnAttribute name="sex" displayName="Sex" sortable="false"/>
	    <columnAttribute name="Sample_Type" displayName="Sample Type" sortable="false"/>
<!--           <columnAttribute name="Participant_Type" displayName="Population included" sortable="false"/> -->
            <columnAttribute name="Study_Type"  displayName="Investigation Type" sortable="false"/>
            <columnAttribute name="Study_Design"  displayName="Study Design" sortable="false"/>
	    <columnAttribute name="Country"  displayName="Country" sortable="false"/>
            <columnAttribute name="Years"  displayName="Years" sortable="false"/>
            <columnAttribute name="Variable_count" displayName="Variables" sortable="false"/>
            <columnAttribute name="HH_count"  displayName="Households" sortable="false"/>
            <columnAttribute name="Part_count" displayName="Participants" sortable="false"/>
            <columnAttribute name="Obser_count" displayName="Participant Repeated Measures" sortable="false"/>
            <columnAttribute name="Samp_count"  displayName="Samples" sortable="false"/>
            <columnAttribute name="AdditionalData"  displayName="Additional Data" sortable="false"/>
            <columnAttribute name="Age"  displayName="Age" sortable="false"/>
            <columnAttribute name="WHO"  displayName="WHO indicator subdomain" sortable="false"/>
            <columnAttribute name="ProjectName"  displayName="Project Name" sortable="false"/>
        </table>



	<!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- clinepi versioning download files table -->
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <table name="DownloadVersion"  includeProjects="ClinEpiDB,MicrobiomeDB,VectorBase,PlasmoDB,HostDB,EuPathDB"
               displayName="Data Versions"
               queryRef="DatasetTables.DownloadVersion">
            <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="dataset_name"  inReportMaker="false" internal="true"/>

            <columnAttribute name="version_number" inReportMaker="false" internal="true"/>

            <textAttribute name="version_number_link" inReportMaker="false" internal="false"
                           displayName="Download link">
              <text>
                <![CDATA[
                  <button
                    type="button"
                    class="study-action link"
                    data-study-id="$$dataset_id$$"
                    data-args='{
                      "type": "download",
                      "downloadUrl": "@WEBAPP_BASE_URL@/downloads/release-$$build_number$$/$$dataset_sha1_digest$$"
                    }'
                  >$$version_number$$</button>
                ]]>
              </text>
            </textAttribute>
            <columnAttribute name="build_number" displayName="Release #"/>
            <columnAttribute name="release_date" displayName="Release Date"/>
            <columnAttribute name="note" displayName="Updates"/>
            <columnAttribute name="dataset_sha1_digest" internal="true"/>     
        </table>



       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- Isolates / Samples -->
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
<!--
        <table name="Isolates"
               displayName="Isolates / Samples"
               queryRef="DatasetTables.Isolates">
            <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="dataset_name"  inReportMaker="false" internal="true"/>
            <columnAttribute name="source_id" inReportMaker="true" internal="true"/>
            <columnAttribute name="strain" inReportMaker="true" internal="true"/>
            <columnAttribute name="contact_name" inReportMaker="true" internal="true"/>
            <linkAttribute name="isolate_link" inReportMaker="false" internal="false"
                           displayName="Isolate Source Id">

                 <displayText>
                    <![CDATA[
                    $$source_id$$ - ($$strain$$) $$contact_name$$
                    ]]>
                 </displayText>
                 <url>
                    <![CDATA[ @WEBAPP_BASE_URL@/record/isolate/$$source_id$$ ]]>
                 </url>
            </linkAttribute>
        </table>
-->
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- Publications (display name for ClinEpiDB) -->
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <table name="Publications"
               displayName="Selected Publications" includeProjects="ClinEpiDB"
               queryRef="DatasetTables.Publications">
            <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="pmid" displayName="Pubmed ID" internal="true"/>
            <columnAttribute name="citation" internal="true"/>
            <columnAttribute name="url" internal="true"/>


            <linkAttribute name="pubmed_link" inReportMaker="false" internal="false"
                           displayName="PubMed Link">

                 <displayText>
                    <![CDATA[
                    $$citation$$
                    ]]>
                 </displayText>
                 <url>
                    <![CDATA[
                             http://www.ncbi.nlm.nih.gov/pubmed/$$pmid$$
                    ]]>
                 </url>
            </linkAttribute>


        </table>




        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- Publications (display name for VEuPathDB) -->
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <table name="Publications"
	       excludeProjects="ClinEpiDB"
               displayName="Associated Publications"
               queryRef="DatasetTables.Publications">
            <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="pmid" displayName="Pubmed ID" internal="true"/>
            <columnAttribute name="citation" internal="true"/>
            <columnAttribute name="url" internal="true"/>


            <linkAttribute name="pubmed_link" inReportMaker="false" internal="false"
                           displayName="PubMed Link">

                 <displayText>
                    <![CDATA[
                    $$citation$$
                    ]]>
                 </displayText>
                 <url>
                    <![CDATA[
                    $$url$$
                    ]]>
                 </url>
            </linkAttribute>


        </table>



        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- External Links -->
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <table name="HyperLinks"
               displayName="External Resources"
               queryRef="DatasetTables.HyperLinks">
            <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="text" internal="true"/>
            <columnAttribute name="url" internal="true"/>

            <linkAttribute name="hyper_link" inReportMaker="false" internal="false"
                           displayName="Links">

                 <displayText>
                    <![CDATA[
                    $$text$$
                    ]]>
                 </displayText>
                 <url>
                    <![CDATA[
                          $$url$$
                    ]]>
                 </url>
            </linkAttribute>


        </table>

        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- History -->
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
<!--
        <table name="History"
               displayName="Release History"
               queryRef="DatasetTables.History">
            <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="build" displayName="VEuPathDB Build #"/>
            <columnAttribute name="release_date" displayName="Release Date"/>
            <columnAttribute name="note" displayName="Note"/>
        </table>
-->


        <table name="RNASeqSamplesInternal" excludeProjects="MicrobiomeDB,ClinEpiDB"
               displayName="Internal Table for TPM average per sample"
               queryRef="DatasetTables.RNASeqSamplesInternal">
            <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="study_name"/>
            <columnAttribute name="sample"/>
            <columnAttribute name="switch_strands"/>
            <columnAttribute name="average_value"/>
        </table>

        <table name="GenomeHistory" excludeProjects="MicrobiomeDB,ClinEpiDB"
               displayName="Data Set Release History"
               queryRef="DatasetTables.GenomeHistory">
            <description includeProjects="VectorBase"><![CDATA[<i>
                On September 2019, VectorBase and EuPathDB merged into VEuPathDB. Starting with the VEuPathDB Build 47 release in Apr 2020, VectorBase and VEuPathDB share the same Build/Release numeric system. Before Apr 2020 the Release column reflects the legacy VectorBase nomenclature, e.g. VB-2016-06 (VectorBase June 2016 release). 
              </i>]]>
            </description>
            <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="build" displayName="VEuPathDB Build"/>
            <columnAttribute name="release_date" displayName="Release Date"/>
            <columnAttribute name="release_number" displayName="Release"/>
            <columnAttribute name="genome_source" displayName="Genome Source"/>
            <columnAttribute name="genome_version" displayName="Genome Version" internal="true"/>
            <columnAttribute name="assembly_url" internal="true"/>
            <linkAttribute name="genome_link" inReportMaker="false" internal="false"
                           displayName="Genome Version">
                 <displayText>
                    <![CDATA[
                    $$genome_version$$
                    ]]>
                 </displayText>
                 <url>
                    <![CDATA[
                          $$assembly_url$$
                    ]]>
                 </url>
            </linkAttribute>
            <columnAttribute name="annotation_source" displayName="Structural Annotation Source"/>
            <columnAttribute name="annotation_version" displayName="Structural Annotation Version"/>
            <columnAttribute name="functional_annotation_source" displayName="Functional Annotation Source"/>
            <columnAttribute name="functional_annotation_version" displayName="Functional Annotation Version"/>
            <columnAttribute name="note" displayName="Note"/>
        </table>

        <table name="DatasetHistory" excludeProjects="MicrobiomeDB,ClinEpiDB"
               displayName="Data Set Release History"
               queryRef="DatasetTables.DatasetHistory">
            <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="build" displayName="VEuPathDB Build"/>
            <columnAttribute name="release_date" displayName="Release Date"/>
            <columnAttribute name="release_number" displayName="Release"/>
            <columnAttribute name="version" displayName="Data Set Version"/>
            <columnAttribute name="note" displayName="Note"/>
        </table>

        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- References -->
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <table name="References"  excludeProjects="MicrobiomeDB,ClinEpiDB"
               displayName="Explore this Data Set within this Website"
               queryRef="DatasetTables.References">
            <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="dataset_name"  inReportMaker="false" internal="true"/>
            <columnAttribute name="text" inReportMaker="false" internal="true"/>
            <columnAttribute name="url" inReportMaker="false" internal="true"/>
            <columnAttribute name="description" inReportMaker="false" internal="true"/>
            <columnAttribute name="record_type" displayName="Record Type" />
            <columnAttribute name="target_type" displayName="Type of Reference"/>
            <columnAttribute name="target_name" displayName="Name"/>
            <columnAttribute name="link_type" displayName="link_type"/>
        </table>

        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- Version   -->
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
       <table name="Version"
               displayName="Provider's Version"
	       excludeProjects="MicrobiomeDB,ClinEpiDB"
               queryRef="DatasetTables.Version">
            <columnAttribute name="dataset_name"  inReportMaker="false" internal="true"/>
            <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="organism" displayName="Reference Organism"/>
            <columnAttribute name="version" displayName="Version"/>
            <columnAttribute name="project_id" displayName="Project"/>
        </table>

<!--
      <table name="DatasetGeneTable"
             displayName="Dataset Gene Table"
             queryRef="DatasetTables.DatasetGeneTable">
        <columnAttribute name="dataset_name" displayName="Dataset Name"/>
        <columnAttribute name="source_id" displayName="Gene ID"/>
        <columnAttribute name="fdiff" displayName="Fold Difference"/>
        <columnAttribute name="min_value" displayName="Min value"/>
        <columnAttribute name="min_timepoint" displayName="Min timepoint"/>
        <columnAttribute name="max_value" displayName="Max value"/>
        <columnAttribute name="max_timepoint" displayName="Max timepoint"/>
      </table>
-->

        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- request stats table -->
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
	<table name="AccessRequestStats" includeProjects="ClinEpiDB"
               displayName="Data Access Statistics
"
               queryRef="DatasetTables.AccessRequestStats">
          <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
          <columnAttribute name="dataset_name"  inReportMaker="false" internal="true"/>
          <columnAttribute name="total" displayName="Total requests"/>
	  <columnAttribute name="approved" displayName="Approved requests"/>
	  <columnAttribute name="approved_percent" displayName="Percent approved"/>

        </table>

       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- request table -->
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <table name="AccessRequest" includeProjects="ClinEpiDB"
               displayName="Data Access Records"
               queryRef="DatasetTables.AccessRequest">
          <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
          <columnAttribute name="dataset_name"  inReportMaker="false" internal="true"/>
          <columnAttribute name="name" displayName="Name"/>
          <columnAttribute name="organization" displayName="Organization"/>
          <columnAttribute name="start_date" displayName="Date"/>
          <columnAttribute name="purpose" displayName="Purpose"/>

        </table>

        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- Transcript type counts -->
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <table name="TranscriptTypeCounts" 
               excludeProjects="MicrobiomeDB,ClinEpiDB"
               displayName="Transcript Types"
               queryRef="DatasetTables.TranscriptTypeCounts">
            <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="gene_type"  displayName="Gene type"/>
            <columnAttribute name="transcript_type" displayName="Transcript type"/>
            <columnAttribute name="transcript_count" displayName="Transcript count"/>
        </table>

        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- Gene type counts -->
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <table name="GeneTypeCounts" 
               excludeProjects="MicrobiomeDB,ClinEpiDB"
               displayName="Gene Types"
               queryRef="DatasetTables.GeneTypeCounts">
            <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="gene_type"  displayName="Gene type"/>
            <columnAttribute name="gene_count" displayName="Gene count"/>
        </table>

        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- Sequence type counts -->
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <table name="SequenceTypeCounts" 
               excludeProjects="EuPathDB,MicrobiomeDB,ClinEpiDB"
               displayName="Sequence Types (Highest Level of Assembly)"
               queryRef="DatasetTables.SequenceTypeCounts">
            <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="sequence_type"  displayName="Sequence type"/>
            <columnAttribute name="sequence_count" displayName="Sequence count"/>
        </table>


      <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
      <!-- Busco -->
      <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

      <table name="Busco" excludeProjects="EuPathDB,HostDB,MicrobiomeDB,ClinEpiDB"
             displayName="BUSCO"
             queryRef="DatasetTables.Busco">
        <description><![CDATA[<i>
Based on evolutionarily informed expectations of gene content of near-universal single-copy orthologs, BUSCO metric complements technical metrics like N50. For a comprehensive user guide, including result interpretation, the latest citation, and additional information, please refer to the following link: <a href="https://busco.ezlab.org">https://busco.ezlab.org</a>. The current version employed by VEuPathDB is v5.4.7. In "genome" mode, BUSCO utilized the MetaEuk gene predictor, while the official protein set of each genome was employed for BUSCO runs in "proteins" mode.
</i>]]></description>
        <!-- columnAttribute name="organism_id" internal="true"/ -->
        <columnAttribute name="sequence_type" displayName="SequenceType"/>
        <columnAttribute name="c_score" displayName="Complete BUSCOs (C)"/>
        <columnAttribute name="s_score" displayName="Complete and single-copy BUSCOs (S)"/>
        <columnAttribute name="d_score" displayName="Complete and duplicated BUSCOs (D) "/>
        <columnAttribute name="f_score" displayName="Fragmented BUSCOs (F)"/>
        <columnAttribute name="m_score" displayName="Missing BUSCOs (M)"/>
        <columnAttribute name="lineage_dataset" displayName="Lineage Dataset"/>
      </table>




        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- Other data associated with genomes -->
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <table name="GenomeAssociatedData" 
               excludeProjects="MicrobiomeDB,ClinEpiDB,EuPathDB"
               displayName="Explore other Categories of Data Associated with this Genome"
               queryRef="DatasetTables.GenomeAssociatedData">
            <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="category"  displayName="Category"/>
            <columnAttribute name="organism"  displayName="organism" internal="true"/>
            <columnAttribute name="dataset_count" displayName="Dataset count" internal="true"/>
            <linkAttribute name="hyper_link" inReportMaker="false" internal="false"
                           displayName="Dataset count">
                 <displayText>
                    <![CDATA[
                    $$dataset_count$$
                    ]]>
                 </displayText>
                 <url>
                    <![CDATA[
                          @WEBAPP_BASE_URL@/search/dataset/DatasetsByCategoryAndOrganism?param.organism=$$organism$$&param.dataset_category=$$category$$&autoRun=1
                    ]]>
                 </url>
            </linkAttribute>
        </table>

        
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- External Resources and Databases for genomes -->
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <table name="ExternalDatabases" 
               excludeProjects="EuPathDB,MicrobiomeDB,ClinEpiDB"
               displayName="External Databases Associated to Genome Annotation"
               queryRef="DatasetTables.ExternalDatabases">
            <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="name"  internal="true"/>
            <columnAttribute name="id_url"  internal="true"/>
            <textAttribute name="external_link" inReportMaker="false" internal="false"
                           displayName="Name">
                 <text>
                    <![CDATA[
                    <a href=$$id_url$$ target="_blank">$$name$$</a>
                    ]]>
                 </text>
            </textAttribute>
        </table>

      <table name="AssociatedDatasets"
             displayName="Associated Data Sets"
             queryRef="DatasetTables.AssociatedDatasets">
        <columnAttribute name="pmid" internal="true"/>
        <columnAttribute name="associated_dataset_id" internal="true"/>
        <columnAttribute name="project" internal="true"/>
        <columnAttribute name="webapp_name" internal="true"/>
        <columnAttribute name="display_name" internal="true"/>

        <linkAttribute displayName="PubMed ID" name="pubmed_link"
                       internal="false">
             <displayText>
                <![CDATA[
                $$pmid$$
                ]]>
             </displayText>
             <url>
                <![CDATA[ https://pubmed.ncbi.nlm.nih.gov/$$pmid$$/ ]]>
             </url>
        </linkAttribute>

        <linkAttribute displayName="Dataset" name="associated dataset" 
                       internal="false">
             <displayText>
                <![CDATA[
                $$project$$: $$display_name$$
                ]]>
             </displayText>
             <url>
                <![CDATA[ http://$$project$$.org/$$webapp_name$$/app/record/dataset/$$associated_dataset_id$$ ]]>
             </url>
        </linkAttribute>

      </table>

        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- User Dataset Dependencies (for use internally, eg, by jbrowse2 config) -->
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <table name="UdDependencies"
               displayName=""
               queryRef="DatasetTables.UdDependencies">
            <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="identifier"  />
            <columnAttribute name="display_name"/>
            <columnAttribute name="version" />
        </table>

      </recordClass>
    </recordClassSet>




  <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
      <!-- Attribute queries -->
      <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <querySet name="LegacyDatasetAttributes" queryType="attribute" doNotTest="true"
              isCacheable='false'  excludeProjects="MicrobiomeDB,ClinEpiDB,EuPathDB">

      <testRowCountSql>
        select count(*) from apidb.legacydataset
      </testRowCountSql>

      <sqlQuery name="DatasetName" isCacheable="false">
        <column name="dataset_presenter_name"/>
        <column name="dataset_presenter_id"/>
        <column name="project_name"/>
        <sql>
          select dataset_presenter_id, dataset_presenter_name, project_name
          from apidb.legacydataset
        </sql>
      </sqlQuery>

      </querySet>


    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
      <!-- Attribute queries -->
      <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <querySet name="DatasetAttributes" queryType="attribute" doNotTest="true"
              isCacheable='false'>

      <testRowCountSql excludeProjects="ClinEpiDB,MicrobiomeDB">
        select count(*) from ApidbTuning.DatasetPresenter
      </testRowCountSql>

      <testRowCountSql includeProjects="ClinEpiDB,MicrobiomeDB">
        select count(*) from (
          SELECT dataset_presenter_id
          FROM apidbtuning.datasetpresenter
          WHERE project_id = '@PROJECT_ID@'
          UNION
          SELECT d.user_dataset_id
          FROM @VDI_CONTROL_SCHEMA@.availableuserdatasets d
        );
      </testRowCountSql>

      <sqlQuery name="genecounts" isCacheable="false" excludeProjects="MicrobiomeDB,ClinEpiDB">
        <column name="dataset_id"/>
        <column name="gene_count"/>
        <sql excludeProjects="MicrobiomeDB,ClinEpiDB">
          select dsp.dataset_presenter_id as dataset_id
            , count(*) as gene_count
          from apidbtuning.organismattributes oa
            , apidbtuning.geneattributes ga
            , apidbtuning.datasetpresenter dsp
            , apidbtuning.datasetnametaxon dnt
          where oa.component_taxon_id = ga.taxon_id
          and oa.project_id = ga.project_id
          and oa.component_taxon_id = dnt.taxon_id
          and dnt.dataset_presenter_id = dsp.dataset_presenter_id
          and dsp.type = 'genome'
          and dsp.project_id = '@PROJECT_ID@'
          group by oa.project_id, dsp.dataset_presenter_id
        </sql>
      </sqlQuery>

      <sqlQuery name="EdaStudyMapping" isCacheable="false" includeProjects="MicrobiomeDB,ClinEpiDB,VectorBase">
        <column name="dataset_id" columnType="string"/>
        <column name="eda_study_id" columnType="string"/>
        <sql>
          <![CDATA[
            select 
              dataset_presenter_id as dataset_id,
              study_stable_id as eda_study_id
            from apidbtuning.datasetpresenter
            left join apidbtuning.studyiddatasetid
            on dataset_id = dataset_presenter_id
            where project_id = '@PROJECT_ID@'
          UNION
            select
              dataset_stable_id as dataset_id,
              study_stable_id as eda_study_id
            from @VDI_DATASETS_SCHEMA@.userstudydatasetid
          ]]>
        </sql>
      </sqlQuery>


      <sqlQuery name="NewCategory" isCacheable="false">
         <column name="newcategory" columnType="string"/>
         <column name="dataset_id" columnType="string"/>
         <sql excludeProjects="EuPathDB,UniDB">
           <![CDATA[
                       select dsp.dataset_presenter_id as dataset_id,
                              nvl(dsp.display_category, dsp.category) as newcategory
                         from ApidbTuning.DatasetPresenter dsp
                         where project_id = '@PROJECT_ID@'
                    UNION
                  select DISTINCT
                    CONCAT('EDAUD_', d.user_dataset_id) as dataset_id,
                    null as newcategory
                  from @VDI_CONTROL_SCHEMA@.availableuserdatasets d
                ]]>
        </sql>
         <sql includeProjects="UniDB">
           <![CDATA[
                       select dsp.dataset_presenter_id as dataset_id,
                              nvl(dsp.display_category, dsp.category) as newcategory
                         from ApidbTuning.DatasetPresenter dsp
                    UNION
                  select DISTINCT
                    CONCAT('EDAUD_', d.user_dataset_id) as dataset_id,
                    null as newcategory
                  from @VDI_CONTROL_SCHEMA@.availableuserdatasets d
                ]]>
        </sql>
         <sql includeProjects="EuPathDB">
           <![CDATA[
                       select dsp.dataset_presenter_id as dataset_id,
                              nvl(dsp.display_category, dsp.category) as newcategory
                         from ApidbTuning.DatasetPresenter dsp
                ]]>
        </sql>
      </sqlQuery>

      <sqlQuery name="DatasetDigest" isCacheable="false" includeProjects="MicrobiomeDB,ClinEpiDB,VectorBase">
        <column name="dataset_sha1_digest" columnType="string"/>
        <column name="dataset_display_name" columnType="string"/>
        <column name="dataset_id" columnType="string"/>
          <sql includeProjects="ClinEpiDB,MicrobiomeDB">
            <![CDATA[
                       select dsp.dataset_sha1_digest
                         , dsp.dataset_presenter_id as dataset_id
                         , dsp.display_name as dataset_display_name
                       from ApidbTuning.DatasetPresenter dsp
                       where dsp.project_id = '@PROJECT_ID@'
                    UNION
                  select DISTINCT
                    null as dataset_sha1_digest,
                    CONCAT('EDAUD_', d.user_dataset_id) as dataset_id,
                    d.name as dataset_display_name
                  from @VDI_CONTROL_SCHEMA@.availableuserdatasets d
                ]]>
        </sql>
          <sql includeProjects="VectorBase">
            <![CDATA[
                       select dsp.dataset_sha1_digest
                         , dsp.dataset_presenter_id as dataset_id
                         , dsp.display_name as dataset_display_name
                       from ApidbTuning.DatasetPresenter dsp
                       where dsp.project_id = '@PROJECT_ID@'
                    UNION
                  select DISTINCT
                    null as dataset_sha1_digest,
                    CONCAT('EDAUD_', d.user_dataset_id) as dataset_id,
                    d.name as dataset_display_name
                  from @VDI_CONTROL_SCHEMA@.availableuserdatasets d
                ]]>
        </sql>
      </sqlQuery>

      <sqlQuery name="ClinepiStudyAttributes"  isCacheable="false" includeProjects="MicrobiomeDB,ClinEpiDB">
         <column name="dataset_id" columnType="string"/>
         <column name="is_public" columnType="string"/>
         <column name="is_prerelease" columnType="string"/>
         <column name="project_availability" columnType="string"/>
         <column name="study_access" columnType="string"/>
         <column name="days_for_approval"/>
         <column name="policy_url" columnType="string"/>
         <column name="card_headline" columnType="string"/>
         <column name="card_points" columnType="string"/>
         <column name="card_questions" columnType="string"/>
         <column name="request_protection_level" columnType="string"/>
         <column name="request_access_fields" columnType="string"/>
         <column name="request_email" columnType="string"/>
         <column name="request_email_bcc" columnType="string"/>
         <column name="request_email_body" columnType="string"/>
         <column name="request_needs_approval" columnType="string"/>
         <column name="request_email_body_manager" columnType="string"/>
         <column name="request_email_body_requester" columnType="string"/>
         <column name="custom_download_tab" columnType="string"/>
         <column name="custom_download_ack" columnType="string"/>
            <sql>
            <![CDATA[
select dts.*,bcc.request_email_bcc
from
(
SELECT   pres.dataset_presenter_id as dataset_id, 
         project_availability, 
         is_public, 
         initcap(dp.study_access) as study_access, 
         days_for_approval, 
         policy_url, 
         card_headline, 
         card_points, 
         card_questions, 
         request_protection_level, 
         request_access_fields, 
         request_email, 
         request_email_body, 
         request_needs_approval, 
         request_email_body_manager, 
         request_email_body_requester, 
         custom_download_tab, 
         custom_download_ack, 
         decode(study_access, 'prerelease', '1', '0') as is_prerelease
FROM   -- pres, bcc, dp
  apidbtuning.datasetpresenter pres, 
  (
  select * from (
    select dataset_presenter_id, property, value
      from apidbtuning.datasetproperty
      where property in ('studyCategories', 
                         'projectAvailability', 
                         'isPublic', 
                         'studyAccess', 
                         'daysForApproval', 
                         'policyUrl', 
                         'cardHeadline', 
                         'cardPoints', 
                         'cardQuestions', 
                         'requestProtectionLevel', 
                         'requestAccessFields', 
                         'requestEmail', 
                         'requestEmailBody', 
                         'requestNeedsApproval', 
                         'requestEmailBodyRequester', 
                         'requestEmailBodyManager', 
                         'customDownloadTab', 
                         'customDownloadAck')
        and trim(value) is not null
-- TEMPLATE_ANCHOR injectDatasetQuestions

-- TEMPLATE_ANCHOR injectProjectAvailability
    )
    pivot
    (
     max(value)
     for property in ('projectAvailability' as project_availability, 
                    'isPublic' as is_public, 
                    'studyAccess' as study_access, 
                    'daysForApproval' as days_for_approval, 
                    'policyUrl' as policy_url, 
                    'cardHeadline' as card_headline, 
                    'cardPoints' as card_points, 
                    'cardQuestions' as card_questions, 
                    'requestProtectionLevel' as request_protection_level, 
                    'requestAccessFields' as request_access_fields, 
                    'requestEmail' as request_email, 
                    'requestEmailBody' as request_email_body, 
                    'requestNeedsApproval' as request_needs_approval, 
                    'requestEmailBodyManager' as request_email_body_manager, 
                    'requestEmailBodyRequester' as request_email_body_requester, 
                    'customDownloadTab' as custom_download_tab, 
                    'customDownloadAck' as custom_download_ack )
    )
  ) dp
WHERE pres.dataset_presenter_id = dp.dataset_presenter_id(+)
  AND project_id = '@PROJECT_ID@'
) dts
LEFT OUTER JOIN
(
  SELECT dataset_id,
         LISTAGG(email, ',') WITHIN GROUP (ORDER BY email)  "REQUEST_EMAIL_BCC"
    FROM useraccounts.accounts@ACCT_DBLINK@ acc, 
         studyaccess.providers@ACCT_DBLINK@ pr
   where pr.user_id = acc.user_id
     and is_manager = 1
   GROUP BY dataset_id
   ORDER BY dataset_id
) bcc
ON dts.dataset_id = bcc.dataset_id 
UNION
-- installed user datasets       
SELECT CONCAT('EDAUD_', d.user_dataset_id) as dataset_stable_id
               , null as project_availability
               , 'NA' as is_public
               , 'NA' as study_access
               , null  as days_for_approval
               , '0' as is_prerelease
               , null as policy_url
               , 'TODO_CARD_HEADLINE' as card_headline
               , '[]' as card_points
               , '[]' as card_questions
               , null as request_protection_level
               , null as request_access_fields
               , null as request_email
               , null as request_email_bcc
               , null as request_email_body
               , null as request_needs_approval
               , null as request_email_body_requester
               , null as request_email_body_manager
               , null as custom_download_tab
               , null as custom_download_ack
          from @VDI_CONTROL_SCHEMA@.availableuserdatasets d
            ]]>
            </sql>
      </sqlQuery>





      <sqlQuery name="MicrobiomeStudyAttributes"  isCacheable="false" includeProjects="MicrobiomeDB">
         <column name="dataset_id" columnType="string"/>
         <column name="study_categories" columnType="string"/>
            <sql>
            <![CDATA[
select pres.dataset_presenter_id as dataset_id, dp.study_categories
from apidbtuning.datasetpresenter pres, (
select * from (
select dataset_presenter_id, property, value
from apidbtuning.datasetproperty
where  property in ('studyCategories')
and trim(value) is not null
-- TEMPLATE_ANCHOR injectDatasetQuestions

-- TEMPLATE_ANCHOR injectProjectAvailability
)
pivot
(
   max(value)
   for property in ('studyCategories' as study_categories )
)) dp
where pres.dataset_presenter_id = dp.dataset_presenter_id(+)
                    UNION
          select
            CONCAT('EDAUD_', d.user_dataset_id) as dataset_id,
            null as study_categories
          from @VDI_CONTROL_SCHEMA@.availableuserdatasets d
            ]]>
            </sql>
      </sqlQuery>


       <sqlQuery name="StudyReqStats"  isCacheable="false" includeProjects="ClinEpiDB">
        <column name="dataset_id" columnType="string"/>
        <column name="total"  sortingColumn="total_number" />
        <column name="approved" sortingColumn="approved_number" />
        <column name="percent_approved"  sortingColumn="percent_approved_number" />
        <column name="total_number" columnType="number"/>
        <column name="approved_number" columnType="number"/>
        <column name="percent_approved_number" columnType="number"/>

        <sql>
          <![CDATA[
select dataset_id, 
       CASE
         WHEN dp.value in ('public','prerelease') THEN 0.5
         WHEN total_number is null THEN 0.1
         ELSE total_number
       END as total_number,
       CASE
         WHEN dp.value in ('public','prerelease') THEN 0.5
         WHEN approved_number is null THEN 0.1
         ELSE approved_number
       END as approved_number,
       CASE
         WHEN dp.value in ('public','prerelease') THEN 0.5
         WHEN percent_approved_number is null THEN 0.1
         ELSE percent_approved_number
       END as percent_approved_number,
       CASE
         WHEN dp.value in ('public','prerelease') THEN 'N/A'
         WHEN total_number > 0 THEN CAST(total_number AS VARCHAR(10))
         ELSE '0'
       END as total,
       CASE
         WHEN dp.value in ('public','prerelease') THEN 'N/A'
         WHEN approved_number > 0 THEN CAST(approved_number AS VARCHAR(10))
         ELSE '0'
       END as approved,
       CASE
         WHEN dp.value in ('public','prerelease') THEN 'N/A'
         WHEN percent_approved_number > 0  THEN percent_approved_number ||'%'
         ELSE '0'
       END as percent_approved
from
(
select pres.dataset_presenter_id as dataset_id, total_number, approved_number,percent_approved_number
from   apidbtuning.datasetpresenter pres
LEFT OUTER JOIN  (
  select DATASET_PRESENTER_ID, total_number, approved_number,
       CASE  
         WHEN total_number > 0  THEN ROUND(100*approved_number/total_number,0)
         ELSE 0
       END as percent_approved_number
  from ( 
    select DATASET_PRESENTER_ID,  
         count(1) as total_number, 
         count(case when approval_status_id = 0 then 1 end) as approved_number
    from studyaccess.end_users@ACCT_DBLINK@ eu
    group by dataset_presenter_id
  )
) mycounts
ON pres.dataset_presenter_id = mycounts.dataset_presenter_id
) mystudies, 
  apidbtuning.datasetproperty dp
where mystudies.dataset_id = dp.dataset_presenter_id
  and dp.property= 'studyAccess'
                    UNION
          SELECT DISTINCT CONCAT('EDAUD_', d.user_dataset_id) as dataset_id
                 , null
                 , null
                 , null
                 , null
                 , null
                 , null
          from @VDI_CONTROL_SCHEMA@.availableuserdatasets d
      ]]>
        </sql>
      </sqlQuery>




      <sqlQuery name="StudyCharacteristic"  isCacheable="false" includeProjects="ClinEpiDB">
        <column name="dataset_id" columnType="string"/>
        <column name="disease" columnType="string"/>
        <column name="sex" columnType="string"/>
	<column name="Sample_Type" columnType="string"/>
        <column name="Participant_Type" columnType="string"/>
        <column name="Study_Type" columnType="string"/>
        <column name="Study_Design" columnType="string"/>
	<column name="Country" columnType="string"/>
        <column name="Years" columnType="string"/>
        <column name="Variable_count" columnType="number"/>
        <column name="HH_count" columnType="number"/>
        <column name="Part_count" columnType="number"/>
        <column name="Obser_count" columnType="number"/>
        <column name="Samp_count" columnType="number"/>
        <column name="AdditionalData" columnType="string"/>
        <column name="Age" columnType="string"/>
        <column name="WHO" columnType="string"/>
        <column name="ProjectName" columnType="string"/>

        <sql>
          <![CDATA[
                   WITH etypes AS
                     (SELECT sd.study_stable_id
                           , sd.dataset_id as dataset_id
                           , etg.display_name
                           , etg.stable_id
                           , et.cardinality AS entity_type_count
                     FROM eda.entitytype et
                        , eda.entitytypegraph etg
                        , apidbtuning.studyiddatasetid sd
                        , apidbtuning.datasetpresenter dp
                     WHERE et.entity_type_id = etg.entity_type_id
                     AND etg.study_stable_id = sd.study_stable_id
                     AND sd.dataset_id = dp.dataset_presenter_id
                     ),
                     all_counts AS
                     (SELECT  dataset_id
                           , listagg(etypes.display_name || ':' || entity_type_count, '; ') 
                             within GROUP (ORDER BY etypes.display_name) all_counts
                     FROM etypes
                     GROUP BY dataset_id
                     ),
                     select_counts AS
                     (SELECT dataset_id
                           , TRIM(TO_CHAR(HH_count, '999,999,999,999,999')) HH_count
                           , TRIM(TO_CHAR(Part_count, '999,999,999,999,999')) Part_count
                           , TRIM(TO_CHAR(Obser_count, '999,999,999,999,999')) Obser_count
                           , TRIM(TO_CHAR(Samp_count, '999,999,999,999,999')) Samp_count
                     FROM
                       (SELECT dataset_id
                             , entity_type_count
                             , stable_id
                        FROM etypes
                       ) 
                       pivot 
                         ( MAX(entity_type_count) 
                           FOR stable_id IN ('PCO_0000024' AS HH_count
                                           , 'EUPATH_0000096' AS Part_count
                                           , 'EUPATH_0000738' AS Obser_count
                                           , 'EUPATH_0000609' AS Samp_count) 
                         )
                     ),
                     syn AS 
                     (SELECT s.ontology_term_id,  ot.source_id,  s.ontology_synonym as label
                      FROM sres.ontologySynonym  s
                      LEFT JOIN sres.ExternalDataBaseRelease edr ON s.external_database_release_ID = edr.external_database_release_ID
                      LEFT JOIN sres.ExternaldataBase ed ON edr.external_database_id = ed.external_database_id
                      LEFT JOIN sres.OntologyTerm ot ON s.ontology_term_id = ot.ontology_term_id
                      WHERE ed.name = 'OntologyTerm_classifications_RSRC'
                       ) ,
                     study_chars as
                      (select dataset_id
                            , disease
                            , sex
                            , Sample_Type
                            , Participant_Type
                            , Study_Type
                            , Study_Design
                            , Country
                            , Years
                            , AdditionalData 
                            , Age
                            , WHO
                            , ProjectName 
                       from
                        (select sd.dataset_id, syn.label, sc.value
                         from eda.studycharacteristic sc
                            , eda.study s
                            , apidbtuning.studyiddatasetid sd
                            , syn
                         where sc.attribute_id = syn.ontology_term_id
                         and s.stable_id = sd.study_stable_id
                         and sc.study_id = s.study_id)
                         pivot
                          (
                           listagg(value, ', ')
                           for label in ('Disease' as Disease
                                       , 'Sample type' as Sample_Type
                                       , 'Sex' as Sex
                                       , 'Population included' as Participant_Type
                                       , 'Investigation type' as Study_Type
                                       , 'Study design' as Study_Design
                                       , 'Country' as Country
                                       , 'Years' as Years
                                       , 'Additional data' as AdditionalData
                                       , 'Age' as Age
                                       , 'WHO indicator subdomain' as WHO
                                       , 'Project name' as ProjectName)
                           )
                       ),
                       variable_counts as 
                        (select sd.dataset_id, count(distinct att.stable_id) as Variable_count
                         from eda.attribute att
                            , eda.entitytype et
                            , eda.study s
                            , apidbtuning.studyiddatasetid sd
                         where att.entity_type_id = et.entity_type_id
                         and et.study_id = s.study_id
                         and s.stable_id = sd.study_stable_id
                        group by sd.dataset_id
                       )
                       select dsp.dataset_presenter_id as dataset_id
                           , select_counts.HH_count
                           , select_counts.Part_count
                           , select_counts.Obser_count
                           , select_counts.Samp_count
                           , variable_counts.Variable_count
                           , study_chars.disease
                           , study_chars.sex
                           , study_chars.Sample_Type
                           , study_chars.Participant_Type
                           , study_chars.Study_Type
                           , study_chars.Study_Design
                           , study_chars.Country
                           , study_chars.Years
                           , study_chars.AdditionalData
                           , study_chars.Age
                           , study_chars.WHO
                           , study_chars.ProjectName
                       from apidbtuning.datasetpresenter dsp
                          , all_counts
                          , select_counts
                          , study_chars
                          , variable_counts
                       where dsp.dataset_presenter_id = all_counts.dataset_id (+)
                        and dsp.dataset_presenter_id = select_counts.dataset_id (+)
                        and dsp.dataset_presenter_id = study_chars.dataset_id (+)
                        and dsp.dataset_presenter_id = variable_counts.dataset_id (+)

                    UNION
          SELECT DISTINCT CONCAT('EDAUD_', d.user_dataset_id) as dataset_id
               , null
               , null
               , null
               , null
               , null
               , null
               , null
               , null
               , null
               , null
               , null
               , null
               , null
               , null
               , null
               , null
               , null
          from @VDI_CONTROL_SCHEMA@.availableuserdatasets d
          ]]>
        </sql>
      </sqlQuery>


      <sqlQuery name="DatasetDisplayName"  isCacheable="false">
         <column name="dataset_id" columnType="string"/>
         <column name="display_name" ignoreCase="true" columnType="string"/>

         <sql includeProjects="MicrobiomeDB,ClinEpiDB">
            <![CDATA[
            select dsp.dataset_presenter_id as dataset_id, dsp.display_name from apidbtuning.datasetpresenter dsp
                    UNION
            select DISTINCT CONCAT('EDAUD_', d.user_dataset_id) as dataset_id, d.name as display_name
                from @VDI_CONTROL_SCHEMA@.availableuserdatasets d
            ]]>
         </sql>
         <sql includeProjects="EuPathDB">
            <![CDATA[
            select dsp.dataset_presenter_id as dataset_id
                 , case when oa.is_annotated_genome = 1 then '<i>' || oa.species || '</i> ' || oa.strain || ' Genome Sequence and Annotation'
                        when oa.is_annotated_genome = 0 then '<i>' || oa.species || '</i> ' || oa.strain || ' Genome Sequence'   
                        else dsp.display_name
                   end as display_name
            from apidbtuning.datasetpresenter dsp
                 left join apidbtuning.organismattributes oa
                     on dsp.name = oa.internal_abbrev || '_primary_genome_RSRC'
            ]]>
         </sql>
         <sql excludeProjects="MicrobiomeDB,ClinEpiDB,EuPathDB">
            <![CDATA[
            select dsp.dataset_presenter_id as dataset_id
                 , case when oa.is_annotated_genome = 1 then '<i>' || oa.species || '</i> ' || oa.strain || ' Genome Sequence and Annotation'
                        when oa.is_annotated_genome = 0 then '<i>' || oa.species || '</i> ' || oa.strain || ' Genome Sequence'   
                        else dsp.display_name
                   end as display_name
            from apidbtuning.datasetpresenter dsp
                 left join apidbtuning.organismattributes oa
                     on dsp.name = oa.internal_abbrev || '_primary_genome_RSRC'
                    UNION
            select DISTINCT CONCAT('EDAUD_', d.user_dataset_id) as dataset_id, d.name as display_name
                from @VDI_CONTROL_SCHEMA@.availableuserdatasets d
            ]]>
         </sql>
      </sqlQuery>

      <sqlQuery name="GenomicsDatasetAttributes" isCacheable="false" excludeProjects="MicrobiomeDB,ClinEpiDB">
        <column name="dataset_id"/>
        <column name="megabase_pairs"/>
        <column name="genecount"/>

        <sql includeProjects="EuPathDB">
          <![CDATA[
          select dsp.dataset_presenter_id as dataset_id
              , oa.megabps as megabase_pairs
              , nullif(oa.genecount, 0) as genecount
          from apidbtuning.datasetpresenter dsp
              left join apidbtuning.organismattributes oa
                  on dsp.name = oa.internal_abbrev || '_primary_genome_RSRC'
          ]]>
        </sql>

        <sql excludeProjects="EuPathDB">
          <![CDATA[
          select dsp.dataset_presenter_id as dataset_id
              , oa.megabps as megabase_pairs
              , nullif(oa.genecount, 0) as genecount
          from apidbtuning.datasetpresenter dsp
              left join apidbtuning.organismattributes oa
                  on dsp.name = oa.internal_abbrev || '_primary_genome_RSRC'
    UNION
  select CONCAT('EDAUD_', d.user_dataset_id) as dataset_id, null as megabase_pairs, null as genecount
    from @VDI_CONTROL_SCHEMA@.availableuserdatasets d
          ]]>
        </sql>
      </sqlQuery>

      <sqlQuery name="GenomicsStudyAttributes" isCacheable="false" excludeProjects="MicrobiomeDB,ClinEpiDB">
        <column name="dataset_id"/>
        <column name="is_public"/>

        <sql includeProjects="EuPathDB">
          <![CDATA[
          select dsp.dataset_presenter_id as dataset_id
              , dp.is_public
          from apidbtuning.datasetpresenter dsp,
          (
            select * from (
              select dataset_presenter_id, property, value
                from apidbtuning.datasetproperty
                where property in ('isPublic')
                  and trim(value) is not null
            )
            pivot
            (
              max(value)
              for property in ('isPublic' as is_public)
            )
          ) dp
          
          where dsp.dataset_presenter_id = dp.dataset_presenter_id(+)
          ]]>
        </sql>

        <sql excludeProjects="EuPathDB">
          <![CDATA[
          select dsp.dataset_presenter_id as dataset_id
              , dp.is_public
          from apidbtuning.datasetpresenter dsp,
          (
            select * from (
              select dataset_presenter_id, property, value
                from apidbtuning.datasetproperty
                where property in ('isPublic')
                  and trim(value) is not null
            )
            pivot
            (
              max(value)
              for property in ('isPublic' as is_public)
            )
          ) dp
          
          where dsp.dataset_presenter_id = dp.dataset_presenter_id(+)
    UNION
  select CONCAT('EDAUD_', d.user_dataset_id) as dataset_id,
    case when is_public = 1 then 'yes' else 'no' end as is_public
    from @VDI_CONTROL_SCHEMA@.availableuserdatasets d
          ]]>
        </sql>
      </sqlQuery>


      <sqlQuery name="LatestVersion" isCacheable="false" excludeProjects="MicrobiomeDB,ClinEpiDB">
        <column name="dataset_id"/>
        <column name="genome_version"/>
        <column name="annotation_version"/>
        <column name="functional_annotation_version"/>
        <sql includeProjects="EuPathDB">
          <![CDATA[
                   with all_versions as (
                   select dh.dataset_presenter_id
                       , bd.project
                       , bd.release_number
                       , dh.genome_version
                       , dh.annotation_version
                       , dh.functional_annotation_version
                       , row_number() OVER(PARTITION BY dh.dataset_presenter_id ORDER BY bd.build_number desc) rn
                     from ApidbTuning.DatasetHistory dh
                       , ApidbTuning.EupathBuildDates bd 
                     where dh.build_number = bd.build_number
                       and bd.project = '@PROJECT_ID@'
                     order by dh.dataset_presenter_id
                       , bd.build_number desc
                ) ,
                all_versions_filtered as (
                  select * from all_versions where rn = 1
                )
                select dsp.dataset_presenter_id as dataset_id
                  , av.genome_version
                  , av.annotation_version
                  , av.functional_annotation_version
                from all_versions_filtered av, apidbtuning.datasetpresenter dsp
                where dsp.dataset_presenter_id = av.dataset_presenter_id (+)
          ]]>
        </sql>
        <sql excludeProjects="EuPathDB">
          <![CDATA[
                   with all_versions as (
                   select dh.dataset_presenter_id
                       , bd.project
                       , bd.release_number
                       , dh.genome_version
                       , dh.annotation_version
                       , dh.functional_annotation_version
                       , row_number() OVER(PARTITION BY dh.dataset_presenter_id ORDER BY bd.build_number desc) rn
                     from ApidbTuning.DatasetHistory dh
                       , ApidbTuning.EupathBuildDates bd 
                     where dh.build_number = bd.build_number
                       and bd.project = '@PROJECT_ID@'
                     order by dh.dataset_presenter_id
                       , bd.build_number desc
                ) ,
                all_versions_filtered as (
                  select * from all_versions where rn = 1
                )
                select dsp.dataset_presenter_id as dataset_id
                  , av.genome_version
                  , av.annotation_version
                  , av.functional_annotation_version
                from all_versions_filtered av, apidbtuning.datasetpresenter dsp
                where dsp.dataset_presenter_id = av.dataset_presenter_id (+)
    UNION
  select CONCAT('EDAUD_', d.user_dataset_id) as dataset_id, null as genome_version, null as annotation_version, null as functional_annotation_version
    from @VDI_CONTROL_SCHEMA@.availableuserdatasets d
          ]]>
        </sql>
      </sqlQuery>


      <sqlQuery name="All"  isCacheable="false">
         <column name="dataset_id" columnType="string"/>
         <column name="dataset_name" columnType="string"/>
         <column name="dataset_name_pattern" columnType="string"/>
<!--         <column name="display_name" ignoreCase="true"/> -->
         <column name="short_display_name" columnType="string"/>
         <column name="description" columnType="string"/>
         <column name="version" columnType="string"/>
         <column name="summary" columnType="string"/>
         <column name="protocol" columnType="string"/>
         <column name="usage" columnType="string"/>
         <column name="type" columnType="string"/>
         <column name="is_species_scope" columnType="string"/>
         <column name="build_number_introduced" columnType="string"/>
         <column name="eupath_release" sortingColumn="build_number_introduced" columnType="string"/>
         <column name="pmids" columnType="string"/>
         <column name="pmids_download" columnType="string"/>
         <sql excludeProjects="EuPathDB,UniDB">
            <![CDATA[
    with allpubs as (
                      select dp.dataset_presenter_id
                        , nvl2(dp.pmid,'<a href="https://www.ncbi.nlm.nih.gov/pubmed/' || dp.pmid || '">' || dp.citation || '</a>', '<a href="' || dh.url ||'">' || dh.text || '</a>') as publink
                        , dp.pmid
                      from apidbtuning.datasetPublication dp
                      left join apidbtuning.datasethyperlink dh
                        on dp.dataset_presenter_id = dh.dataset_presenter_id
                        and dh.isPublication = 'Y'
                    )
            select dsp.dataset_presenter_id as dataset_id,
                   dsp.name as dataset_name, dsp.dataset_name_pattern,
                   --dsp.display_name,
                   ds.version,
                   dsp.short_display_name, dsp.description,
                   nvl(dsp.summary, dsp.description) as summary,
                   dsp.protocol, dsp.usage,
                   dsp.type,
                   dsp.is_species_scope,
                   dsp.build_number_introduced,
                   nvl(history.eupath_release, introduced.eupath_release) as eupath_release,
                   pubs.pmids,
                   pubs.pmids_download
            from apidbTuning.DatasetPresenter dsp, apidb.datasource ds,
                 (select dataset_presenter_id
                       , dbms_xmlgen.convert(rtrim(xmlagg(xmlelement(e,publink, '<br><br>').extract('//text()') order by publink).getclobval(), '<br><br>'), 1) as pmids
                       , listagg( pmid, ', ') within group (order by pmid) as pmids_download
                     from allpubs
                     group by dataset_presenter_id) pubs,
                 (select dataset_presenter_id,
                         '@PROJECT_ID@ rel. ' || release_number || ', ' || release_date as eupath_release
                  from (select dh.dataset_presenter_id, dh.build_number, to_char(ebd.release_date,'YYYY-MON-DD') as release_date,
                               ebd.release_number, ebd.project,
                               row_number() over (partition by dh.dataset_presenter_id
                                                              order by ebd.release_number desc) rn
                        from apidbTuning.DatasetHistory dh, apidbTuning.EupathBuildDates ebd
                        where dh.build_number = ebd.build_number
                          and ebd.project = '@PROJECT_ID@')
                  where rn = 1) history,
                 (select build_number,
                         '@PROJECT_ID@ rel. ' || release_number || ', ' || release_date as eupath_release
                  from apidbTuning.EupathBuildDates
                        where project = '@PROJECT_ID@') introduced
            where dsp.dataset_presenter_id = history.dataset_presenter_id(+)
              and dsp.build_number_introduced = introduced.build_number(+)
              and dsp.dataset_presenter_id = pubs.dataset_presenter_id(+)
	      and ds.name (+) = dsp.name
                    UNION ALL
          SELECT CONCAT('EDAUD_', d.dataset_id) as dataset_id
               , null as dataset_name
               , null as dataset_name_pattern
               , null as version
               , d.name as short_display_name
               , d.description
               , to_clob(d.summary) as summary
               , null as protocol
               , null as usage
               , null as type
               , null as is_species_scope
               , null as build_number_introduced
               , null as eupath_release
               , null as pmids
               , null as pmids_download
            from @VDI_CONTROL_SCHEMA@.dataset_meta d -- NOTE: We're reaching into VDI control and selecting from dataset_meta here. This is because availabledatasets has duplicate rows and cannot be selected "distinct"ly since we're selecting clobs.
            ]]>
         </sql>

         <sql includeProjects="EuPathDB">
            <![CDATA[
with allpubs as (
                      select dp.dataset_presenter_id
                        , nvl2(dp.pmid,'<a href="https://www.ncbi.nlm.nih.gov/pubmed/' || dp.pmid || '">' || dp.citation || '</a>', '<a href="' || dh.url ||'">' || dh.text || '</a>') as publink
                        , dp.pmid
                      from apidbtuning.datasetPublication dp
                      left join apidbtuning.datasethyperlink dh
                        on dp.dataset_presenter_id = dh.dataset_presenter_id
                        and dh.isPublication = 'Y'
                    ),
       lastVerDS as (
                      select dataset_presenter_id, max(version) as version
                      from apidb.datasource ds, apidbTuning.DatasetPresenter dsp
                      where ds.name (+) = dsp.name
                      group by dataset_presenter_id  )
            select dsp.dataset_presenter_id as dataset_id,
                   dsp.name as dataset_name, dsp.dataset_name_pattern,
                   --dsp.display_name, 
                   lastVerDS.version,
                   dsp.short_display_name, dsp.description,
                   nvl(dsp.summary, dsp.description) as summary,
                   dsp.protocol, dsp.usage, 
                   dsp.type,
                   dsp.is_species_scope,
                   dsp.build_number_introduced,
                   nvl(history.eupath_release, introduced.eupath_release) as eupath_release,
                   pubs.pmids,
                   pubs.pmids_download
            from apidbTuning.DatasetPresenter dsp, lastVerDS,
                 (select dataset_presenter_id
                       , dbms_xmlgen.convert(rtrim(xmlagg(xmlelement(e, publink, ', ').extract('//text()') order by publink).getclobval(), ', '), 1) as pmids
                       , listagg( pmid, ', ') within group (order by pmid) as pmids_download
                     from allpubs
                     group by dataset_presenter_id) pubs,
                 (select dataset_presenter_id,
                         'VEuPathDB rel. ' || release_number || ', ' || release_date as eupath_release
                  from (select dh.dataset_presenter_id, dh.build_number, to_char(ebd.release_date,'YYYY-MON-DD') as release_date,
                               ebd.release_number, ebd.project,
                               row_number() over (partition by dh.dataset_presenter_id
                                                              order by ebd.release_number desc) rn
                        from apidbTuning.DatasetHistory dh, apidbTuning.EupathBuildDates ebd
                        where dh.build_number = ebd.build_number
                          and ebd.project = '@PROJECT_ID@')
                  where rn = 1) history,
                 (select build_number,
                         '@PROJECT_ID@ rel. ' || release_number || ', ' || release_date as eupath_release
                  from apidbTuning.EupathBuildDates
                        where project = '@PROJECT_ID@') introduced
            where dsp.dataset_presenter_id = history.dataset_presenter_id(+)
              and dsp.build_number_introduced = introduced.build_number(+)
              and dsp.dataset_presenter_id = pubs.dataset_presenter_id(+)
              and lastVerDS.dataset_presenter_id = dsp.dataset_presenter_id
              and NOT dsp.name IN ('taxonomy_RSRC','enzymeDB_RSRC','PDBProteinSequences_RSRC','NRDB_RSRC','GO_RSRC')
    UNION ALL
        select dsp.dataset_presenter_id as dataset_id,
               dsp.name as dataset_name, dsp.dataset_name_pattern,
               '' as version,
               dsp.short_display_name, dsp.description,
               nvl(dsp.summary, dsp.description) as summary,
               dsp.protocol, dsp.usage,
               dsp.type,
               dsp.is_species_scope,
               dsp.build_number_introduced,
               '' as eupath_release,
               TO_CLOB('') as pmids,
               '' as pmids_download
       from apidbTuning.DatasetPresenter dsp
       where dsp.name IN ('taxonomy_RSRC','enzymeDB_RSRC','PDBProteinSequences_RSRC','NRDB_RSRC','GO_RSRC')
	]]>
         </sql>


         <sql includeProjects="UniDB">
            <![CDATA[
WITH relinfo as (
select dsp.dataset_presenter_id,  prop.value as project, dsp.name
from APIDBTUNING.datasetpresenter dsp, apidbtuning.datasetproperty prop
where dsp.dataset_presenter_id = prop.dataset_presenter_id
and prop.property = 'projectName')
select  dsp.dataset_presenter_id as dataset_id,
                   dsp.name as dataset_name, dsp.dataset_name_pattern,
                   ds.version,
                   dsp.short_display_name, dsp.description,
                   nvl(dsp.summary, dsp.description) as summary,
                   dsp.protocol, dsp.usage,
                   dsp.type,
                   dsp.is_species_scope,
                   dsp.build_number_introduced,
                   CASE WHEN (r.project is null) THEN  introduced.project ELSE r.project END || ' rel.' || nvl(history.eupath_release, introduced.eupath_release)  as eupath_release,
                   pubs.pmids,
                   pubs.pmids_download
            from apidbTuning.DatasetPresenter dsp, apidb.datasource ds, relinfo r,
                 (select dataset_presenter_id,
--                       listagg('<a href="https://www.ncbi.nlm.nih.gov/pubmed/' || pmid || '">' || citation || '</a>', ', ') within group (order by pmid) as pmids,
                         dbms_xmlgen.convert( rtrim(xmlagg(xmlelement(e, '<a href="https://www.ncbi.nlm.nih.gov/pubmed/' || pmid || '">' || citation || '</a>', ', ').extract('//text()') order by pmid).getclobval(), ', '), 1) as pmids,
                         listagg( pmid, ', ') within group (order by pmid) as pmids_download
                  from ApidbTuning.DatasetPublication
                  group by dataset_presenter_id) pubs,
                 (select dataset_presenter_id,
                         release_number || ', ' || release_date as eupath_release, project
                  from (select dh.dataset_presenter_id, dh.build_number, to_char(ebd.release_date,'YYYY-MON-DD') as release_date,
                               ebd.release_number, ebd.project,
                               row_number() over (partition by dh.dataset_presenter_id
                                                              order by ebd.release_number desc) rn
                        from apidbTuning.DatasetHistory dh, apidbTuning.EupathBuildDates ebd
                        where dh.build_number = ebd.build_number )
                  where rn = 1) history,
                 (select build_number,
                         release_number || ', ' || release_date as eupath_release, project
                  from apidbTuning.EupathBuildDates
                        ) introduced
            where dsp.dataset_presenter_id = history.dataset_presenter_id(+)
              and dsp.build_number_introduced = introduced.build_number(+)
              and dsp.dataset_presenter_id = pubs.dataset_presenter_id(+)
              and dsp.dataset_presenter_id = r.dataset_presenter_id(+)
              and r.project = introduced.project(+)
              and ds.name (+) = dsp.name
                    UNION ALL
          SELECT CONCAT('EDAUD_', d.dataset_id) as dataset_id
               , null as dataset_name
               , null as dataset_name_pattern
               , null as version
               , d.name as short_display_name
               , d.description
               , to_clob(d.summary) as summary
               , null as protocol
               , null as usage
               , null as type
               , null as is_species_scope
               , null as build_number_introduced
               , null as eupath_release
               , null as pmids
               , null as pmids_download
            from @VDI_CONTROL_SCHEMA@.dataset_meta d -- NOTE: We're reaching into VDI control and selecting from dataset_meta here. This is because availabledatasets has duplicate rows and cannot be selected "distinct"ly since we're selecting clobs.
           ]]>
         </sql>
      </sqlQuery>

     <sqlQuery name="OwnerVisibility"  isCacheable="false">
         <column name="dataset_id"/>
         <column name="owner"/>
         <column name="community"/>

         <sql includeProjects="EuPathDB">
            <![CDATA[
            select dsp.dataset_presenter_id as dataset_id,
                   null as owner,
                   null as community
            from apidbTuning.DatasetPresenter dsp
            ]]>
         </sql>

         <sql excludeProjects="EuPathDB">
            <![CDATA[
            select dsp.dataset_presenter_id as dataset_id,
                   null as owner,
                   null as community
            from apidbTuning.DatasetPresenter dsp
            UNION
            SELECT CONCAT('EDAUD_', dataset_id) as dataset_id,
                   owner,
                   is_public as community
                from @VDI_CONTROL_SCHEMA@.dataset 
            ]]>
         </sql>
      </sqlQuery>


      <sqlQuery name="CavAckRP"  isCacheable="false">
         <column name="dataset_id"/>
         <column name="caveat"/>
         <column name="acknowledgement"/>
         <column name="release_policy"/>
         <sql excludeProjects="EuPathDB">
            <![CDATA[
            select dsp.dataset_presenter_id as dataset_id,
                    dsp.caveat, dsp.acknowledgement,
                   dsp.release_policy
            from apidbTuning.DatasetPresenter dsp
            UNION
            SELECT CONCAT('EDAUD_', d.user_dataset_id) as dataset_id
               , null as caveat
               , null as acknowledgement
               , null as release_policy
                from @VDI_CONTROL_SCHEMA@.availableuserdatasets d
            ]]>
         </sql>
         <sql includeProjects="EuPathDB">
            <![CDATA[
            select dsp.dataset_presenter_id as dataset_id,
                    dsp.caveat, dsp.acknowledgement,
                   dsp.release_policy
            from apidbTuning.DatasetPresenter dsp
            ]]>
         </sql>
      </sqlQuery>


      <sqlQuery name="Contacts"  isCacheable="false">
	<column name="dataset_id" columnType="string"/>
	<column name="contact" columnType="string"/>
        <column name="institution" columnType="string"/>
        <column name="email" columnType="string"/>
        <column name="short_attribution" columnType="string"/>
            <sql includeProjects="ClinEpiDB,MicrobiomeDB">
            <![CDATA[
            select dsp.dataset_presenter_id as dataset_id,
                   CASE WHEN  dsc.name is not null THEN dsc.name
                        WHEN dsc.affiliation is not null THEN dsc.affiliation
                        ELSE '<a href="http://eupathdb.org/eupathdb/app/contact-us" class="new-window" data-name="contact_us">Contact VEuPathDB for more details</a>'
                   END as contact,
                   CASE WHEN  (dsc.name is null and dsc.affiliation is not null) THEN dsc.name
                        ELSE   dsc.affiliation END as institution,
                   dsc.email as email,
                   nvl(dsp.short_attribution, dsc.name) as short_attribution
            from ApidbTuning.DatasetPresenter dsp, ApidbTuning.DatasetContact dsc
            where dsp.dataset_presenter_id = dsc.dataset_presenter_id (+)
            and dsc.is_primary_contact = 1
                    UNION
--          SELECT CONCAT('EDAUD_', d.user_dataset_id) as dataset_id
--               , dc.name as contact
--               , affiliation as institution
--               , email
--               , short_attribution
--               from @VDI_CONTROL_SCHEMA@.availableuserdatasets d, @VDI_CONTROL_SCHEMA@.dataset_contact dc
--	       where dc.is_primary = 1
--	       and dc.dataset_id = d.user_dataset_id
          SELECT CONCAT('EDAUD_', d.user_dataset_id) as dataset_id
               , null as contact
               , null as institution
               , null as email
               , null as short_attribution
               from @VDI_CONTROL_SCHEMA@.availableuserdatasets d
 ]]>
            </sql>

            <sql includeProjects="EuPathDB">
            <![CDATA[
            select dsp.dataset_presenter_id as dataset_id,
                   CASE WHEN  dsc.name is not null THEN dsc.name
                        WHEN dsc.affiliation is not null THEN dsc.affiliation
                        ELSE '<a href="http://eupathdb.org/eupathdb/app/contact-us" class="new-window" data-name="contact_us">Contact VEuPathDB for more details</a>'
                   END as contact,
                   CASE WHEN  (dsc.name is null and dsc.affiliation is not null) THEN dsc.name
                        ELSE   dsc.affiliation END as institution,
                   dsc.email as email,
                   nvl(dsp.short_attribution, dsc.name) as short_attribution
            from ApidbTuning.DatasetPresenter dsp, ApidbTuning.DatasetContact dsc
            where dsp.dataset_presenter_id = dsc.dataset_presenter_id (+)
            and dsc.is_primary_contact = 1
 ]]>
            </sql>

            <sql excludeProjects="EuPathDB,ClinEpiDB,MicrobiomeDB">
            <![CDATA[
            select dsp.dataset_presenter_id as dataset_id,
                   CASE WHEN  dsc.name is not null THEN dsc.name
                        WHEN dsc.affiliation is not null THEN dsc.affiliation
                        ELSE '<a href="http://eupathdb.org/eupathdb/app/contact-us" class="new-window" data-name="contact_us">Contact VEuPathDB for more details</a>'
                   END as contact,
                   CASE WHEN  (dsc.name is null and dsc.affiliation is not null) THEN dsc.name
                        ELSE   dsc.affiliation END as institution,
                   dsc.email as email,
                   nvl(dsp.short_attribution, dsc.name) as short_attribution
            from ApidbTuning.DatasetPresenter dsp, ApidbTuning.DatasetContact dsc
            where dsp.dataset_presenter_id = dsc.dataset_presenter_id (+)
            and dsc.is_primary_contact = 1
                    UNION
--          SELECT CONCAT('EDAUD_', d.user_dataset_id) as dataset_id
--               , dc.name as contact
--               , affiliation as institution
--               , email
--               , short_attribution
--               from @VDI_CONTROL_SCHEMA@.availableuserdatasets d, @VDI_CONTROL_SCHEMA@.dataset_contact dc
--	       where dc.is_primary = 1
--	       and dc.dataset_id = d.user_dataset_id
          SELECT CONCAT('EDAUD_', d.user_dataset_id) as dataset_id
               , null as contact
               , null as institution
               , null as email
               , null as short_attribution
               from @VDI_CONTROL_SCHEMA@.availableuserdatasets d
 ]]>
            </sql>

      </sqlQuery>

      <sqlQuery name="inApollo"  isCacheable="false" excludeProjects="MicrobiomeDB,ClinEpiDB">
        <column name="dataset_id"/>
        <column name="in_apollo"/>
            <sql excludeProjects="MicrobiomeDB,ClinEpiDB">
            <![CDATA[
           WITH apollo_dataset as (
             SELECT distinct dsnt.dataset_presenter_id, 'Apollo' as in_apollo
             FROM apidbtuning.datasetnametaxon dsnt
                , apidbtuning.organismattributes tn
                , apidbtuning.ApolloID aid
             WHERE dsnt.taxon_id = tn.component_taxon_id (+)
               AND tn.organism_name = aid.organism(+)
               AND aid.apolloid IS NOT NULL
         ) SELECT dsp.dataset_presenter_id AS dataset_id,
                        CASE WHEN ( in_apollo IS NOT NULL)
                        THEN 'Apollo'
                        ELSE 'N/A' END AS in_apollo
           FROM apollo_dataset ad, apidbtuning.datasetPresenter dsp
          WHERE dsp.dataset_presenter_id = ad.dataset_presenter_id (+)
    UNION
  select CONCAT('EDAUD_', d.user_dataset_id) as dataset_id, 'N/A' as in_apollo
    from @VDI_CONTROL_SCHEMA@.availableuserdatasets d
             ]]>
            </sql>
      </sqlQuery>

    <sqlQuery name="Projects"  isCacheable="false" excludeProjects="EuPathDB">
        <column name="dataset_id" columnType="string"/>
        <column name="project_id" columnType="string"/>
            <sql>
            <![CDATA[
               WITH projprop AS (
                 SELECT dataset_presenter_id, value as project
                 FROM apidbTuning.DatasetProperty
                 WHERE property = 'projectName')
               SELECT DISTINCT dsp.dataset_presenter_id as dataset_id, dsp.name,
                      CASE WHEN (dp.project IS NOT NULL) THEN dp.project
                           ELSE ' ' END  as project_id
               FROM apidbTuning.DatasetPresenter dsp, apidb.Datasource ds,
                    projprop dp
               WHERE ds.name (+) = dsp.name
               AND dsp.dataset_presenter_id = dp.dataset_presenter_id(+)
    UNION
  select CONCAT('EDAUD_', d.user_dataset_id) as dataset_id, project_id as project
    from @VDI_CONTROL_SCHEMA@.availableuserdatasets d
            ]]>
            </sql>
    </sqlQuery>

    <sqlQuery name="Projects"  isCacheable="false" includeProjects="EuPathDB">
        <column name="dataset_id" columnType="string"/>
        <column name="project_id" columnType="string"/>
            <sql>
            <![CDATA[
               WITH projprop AS (
                 SELECT dataset_presenter_id, value as project
                 FROM apidbTuning.DatasetProperty
                 WHERE property = 'projectName')
               SELECT DISTINCT dsp.dataset_presenter_id as dataset_id, dsp.name,
                      CASE WHEN (dp.project IS NOT NULL) THEN dp.project
                           ELSE ' ' END  as project_id
               FROM apidbTuning.DatasetPresenter dsp, apidb.Datasource ds,
                    projprop dp
               WHERE ds.name (+) = dsp.name
               AND dsp.dataset_presenter_id = dp.dataset_presenter_id(+)
            ]]>
            </sql>
    </sqlQuery>


      <sqlQuery name="Organisms"  isCacheable="false">
        <column name="dataset_id"/>
       <column name="organism_prefix"/>
 
            <sql excludeProjects="EuPathDB">
            <![CDATA[
select dataset_id,
  regexp_replace(
    utl_i18n.unescape_reference(to_char( dbms_lob.substr(xmlagg(xmlelement(e,org,'<br>').extract('//text()')  order by org).getclobval() , 4000, 1)) ) , '<br>[A-Za-z\. <>&]+$', '<br>...') AS organism_prefix
from (
select distinct dsnt.dataset_presenter_id as dataset_id
 , case when tn.organism_name is null then null
        else '<i>' || substr(tn.organism_name, 0, instr(tn.organism_name, ' ', 1, 2) -1) || '</i>' || substr(tn.organism_name, instr(tn.organism_name, ' ', 1, 2))
         end as org
from apidbtuning.datasetnametaxon dsnt
 , apidbtuning.organismattributes tn
 where dsnt.taxon_id = tn.component_taxon_id (+)
 )
 group by dataset_id
    UNION
  select CONCAT('EDAUD_', d.user_dataset_id) as dataset_id, null as organism_prefix
    from @VDI_CONTROL_SCHEMA@.availableuserdatasets d
            ]]>
            </sql>
            <sql includeProjects="EuPathDB">
            <![CDATA[
select dataset_id,
  regexp_replace(
    utl_i18n.unescape_reference(to_char( dbms_lob.substr(xmlagg(xmlelement(e,org,'<br>').extract('//text()')  order by org).getclobval() , 4000, 1)) ) , '<br>[A-Za-z\. <>&]+$', '<br>...') AS organism_prefix
from (
select distinct dsnt.dataset_presenter_id as dataset_id
 , case when tn.organism_name is null then null
        else '<i>' || substr(tn.organism_name, 0, instr(tn.organism_name, ' ', 1, 2) -1) || '</i>' || substr(tn.organism_name, instr(tn.organism_name, ' ', 1, 2))
         end as org
from apidbtuning.datasetnametaxon dsnt
 , apidbtuning.datasetPresenter dsp
 , apidbtuning.organismattributes tn
 where dsnt.taxon_id = tn.component_taxon_id (+)
   and dsnt.dataset_presenter_id = dsp.dataset_presenter_id
   and dsp.project_id = tn.project_id(+) 
 )
 group by dataset_id
            ]]>
            </sql>

      </sqlQuery>

      <sqlQuery name="DatasetAlias" doNotTest="true">
         <column name="dataset_id" columnType="string"/>
         <column name="old_dataset_id" columnType="string"/>
         <sql excludeProjects="ClinEpiDB,MicrobiomeDB">
            <![CDATA[
                  select dataset_presenter_id as dataset_id,
                         dataset_presenter_id as old_dataset_id
                  from apidbTuning.DatasetPresenter
                union
                  select dsp.dataset_presenter_id as dataset_id,
                         oa.source_id as old_dataset_id
                  from apidbTuning.DatasetPresenter dsp,
                       apidbTuning.DatasetNameTaxon dnt,
                       apidbTuning.OrganismAttributes oa
                  where dsp.type = 'genome'
                    and dsp.dataset_presenter_id = dnt.dataset_presenter_id
                    and oa.component_taxon_id = dnt.taxon_id
                union
                  select dataset_presenter_id as dataset_id,
                         'DS_' ||
                           lower(substr(standard_hash(replace(name, '_ebi_', '_'), 'SHA1'), 0, 10))
                           as old_dataset_id
                  from apidbtuning.datasetpresenter where name like '%_ebi_%'
                    UNION
            select CONCAT('EDAUD_', d.user_dataset_id) as dataset_id, CONCAT('EDAUD_', d.user_dataset_id) as old_dataset_id
                from @VDI_CONTROL_SCHEMA@.availableuserdatasets d
              ]]>
         </sql>

        <sql includeProjects="ClinEpiDB,MicrobiomeDB">
        <![CDATA[
                  select dataset_presenter_id as dataset_id,
                         dataset_presenter_id as old_dataset_id
                  from apidbTuning.DatasetPresenter
                    UNION
            select CONCAT('EDAUD_', d.user_dataset_id) as dataset_id, CONCAT('EDAUD_', d.user_dataset_id) as old_dataset_id
                from @VDI_CONTROL_SCHEMA@.availableuserdatasets d
        ]]>
        </sql>
      </sqlQuery>

    </querySet>

      <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
      <!-- Table queries -->
      <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <querySet name="DatasetTables" queryType="table"
              isCacheable='false'>

      <sqlQuery name="RNASeqSamplesInternal"  isCacheable='false'>
            <column name="dataset_id"/>
            <column name="study_name"/>
            <column name="sample"/>
            <column name="switch_strands"/>
            <column name="average_value"/>
            <sql>
            <![CDATA[
                     select dnt.dataset_presenter_id as dataset_id
                          , ps.study_name
                          , ps.PROTOCOL_APP_NODE_NAME as sample
                          , dp.value as switch_strands
                          , avg(r.value) as average_value
                     from apidbtuning.profilesamples ps
                        , results.nafeatureexpression r
                        , apidbtuning.datasetnametaxon dnt
                        , apidbtuning.datasetproperty dp
                     where dataset_type = 'transcript_expression'
                     and dataset_subtype = 'rnaseq'
                     and profile_type = 'values'
                     and ps.study_name like '% - tpm - unique%'
                     and ps.protocol_app_node_id = r.protocol_app_node_id
                     and ps.dataset_name = dnt.name
                     and dnt.dataset_presenter_id = dp.dataset_presenter_id
                     and dp.property = 'switchStrandsProfiles'
                     group by dnt.dataset_presenter_id
                            , dp.value
                            , ps.study_name
                           , ps.PROTOCOL_APP_NODE_NAME
            ]]>
            </sql>
      </sqlQuery>







      <sqlQuery name="Publications"  isCacheable='false'>
            <column name="dataset_id"/>
            <column name="pmid"/>
            <column name="citation"/>
            <column name="url"/>
            <sql>
            <![CDATA[
              with pmidPublications as (
                  select dataset_presenter_id as dataset_id
                        , pmid
                        , regexp_replace(citation, '\s+<', ' <') as citation
                        , 'http://www.ncbi.nlm.nih.gov/pubmed/' || pmid as url
			, ROWNUM as rownumber
                  from ApidbTuning.DatasetPublication
                  where pmid is not null
                  order by dataset_publication_id
              ) select dataset_presenter_id as dataset_id
                       , null as pmid
                       , text as citation
                       , url
		       , ROWNUM as rownumber
                from apidbtuning.datasethyperlink
                where isPublication = 'Y'
                union
                select * from pmidPublications
		order by rownumber
            ]]>
            </sql>
      </sqlQuery>

      <sqlQuery name="History"  isCacheable='false'>
            <column name="dataset_id"/>
            <column name="build"/>
            <column name="release_date"/>
            <column name="note"/>
            <sql>
            <![CDATA[
             select dh.dataset_presenter_id as dataset_id, bd.build_number as build, bd.release_date, dh.note
             from ApidbTuning.DatasetHistory dh, ApidbTuning.EupathBuildDates bd
             where dh.build_number = bd.build_number
               and bd.project = '@PROJECT_ID@'
             order by bd.build_number
            ]]>
            </sql>
      </sqlQuery>

      <sqlQuery name="GenomeHistory"  isCacheable='false' excludeProjects="MicrobiomeDB,ClinEpiDB">
            <column name="dataset_id"/>
            <column name="build"/>
            <column name="release_date"/>
            <column name="project"/>
            <column name="release_number"/>
            <column name="genome_source"/>
            <column name="genome_version"/>
            <column name="annotation_source"/>
            <column name="annotation_version"/>
            <column name="functional_annotation_source"/>
            <column name="functional_annotation_version"/>
            <column name="note"/>
            <column name="isin_apollo"/>
            <column name="assembly_url"/>
            <sql excludeProjects="MicrobiomeDB,ClinEpiDB">
            <![CDATA[
            select dh.dataset_presenter_id as dataset_id, 
                    CASE 
                      WHEN (bd.project = 'VectorBase' AND bd.build_number < 47) THEN NULL
                      ELSE bd.build_number
                    END as build,
                    to_char(bd.release_date, 'yyyy-mm-dd') as release_date,
                    bd.project, bd.release_number, dh.genome_source,
                          dh.genome_version, dh.annotation_source, dh.annotation_version,
                    dh.functional_annotation_source, dh.functional_annotation_version,dh.note
                    ,CASE WHEN (aid.apolloid IS NOT NULL)
                        THEN 'Apollo'
                        ELSE 'N/A' END AS isin_apollo,
                    CASE WHEN dh.genome_version LIKE 'G%'
                      THEN 'https://www.ncbi.nlm.nih.gov/data-hub/genome/' || dh.genome_version
                      ELSE 'javascript:void(0);'
                    END AS assembly_url
             from ApidbTuning.DatasetHistory dh, ApidbTuning.EupathBuildDates bd
                   , apidbtuning.datasetnametaxon dnt
                   , apidbtuning.organismattributes tn
                   , apidbtuning.ApolloID aid
             where dh.build_number = bd.build_number
               and bd.project = '@PROJECT_ID@'
               and dh.dataset_presenter_id = dnt.dataset_presenter_id
                   and dnt.taxon_id = tn.component_taxon_id (+)
                   and tn.organism_name = aid.organism(+)
             order by dh.build_number
            ]]>
            </sql>
      </sqlQuery>

      <sqlQuery name="DatasetHistory"  isCacheable='false' excludeProjects="MicrobiomeDB,ClinEpiDB">
            <column name="dataset_id"/>
            <column name="build"/>
            <column name="release_date"/>
            <column name="project"/>
            <column name="release_number"/>
            <column name="version"/>
            <column name="note"/>
            <sql excludeProjects="MicrobiomeDB,ClinEpiDB">
            <![CDATA[
             select dh.dataset_presenter_id as dataset_id
		   , bd.build_number as build
		   , to_char(bd.release_date, 'yyyy-mm-dd') as release_date
		   , bd.project
		   , bd.release_number
		   , ds.version
		   , dh.note
		 from ApidbTuning.DatasetHistory dh
		   , ApidbTuning.EupathBuildDates bd
		   , apidb.datasource ds
		   , ApidbTuning.DatasetPresenter dsp
		 where dh.build_number = bd.build_number
		   and bd.project = '@PROJECT_ID@'
		   and ds.name (+) = dsp.name
		   and dh.dataset_presenter_id = dsp.dataset_presenter_id
		 order by bd.build_number
            ]]>
            </sql>
      </sqlQuery>

      <sqlQuery name="Contacts"  isCacheable='false'>
            <column name="dataset_name"/>
            <column name="dataset_id"/>
            <column name="contact_name"/>
            <column name="affiliation"/>
            <sql>
            <![CDATA[
                     select dsp.name as dataset_name, dsp.dataset_presenter_id as dataset_id,
                            dsc.name as contact_name, dsc.affiliation
                     from ApidbTuning.DatasetPresenter dsp, ApidbTuning.DatasetContact dsc
                     where dsp.dataset_presenter_id = dsc.dataset_presenter_id
                     order by dsc.is_primary_contact desc, dsc.dataset_contact_id asc
            ]]>
            </sql>
      </sqlQuery>


<sqlQuery name="DownloadVersion" isCacheable='false' includeProjects="ClinEpiDB,MicrobiomeDB,VectorBase,PlasmoDB,HostDB,EuPathDB">
            <column name="dataset_name"/>
            <column name="dataset_id"/>
            <column name="release_date"/>
            <column name="version_number"/>
            <column name="note"/>
            <column name="dataset_sha1_digest"/>
            <column name="build_number"/>
            <sql>
            <![CDATA[                                                                                                          
SELECT dataset_name, dataset_id, build_number, release_date , 'Version ' || ROW_NUMBER() OVER (PARTITION BY dataset_id ORDER BY dataset_id, build_number) as version_number, note, dataset_sha1_digest                                                                
FROM (                                                                                                                          
   SELECT distinct dh.dataset_presenter_id as dataset_id, dp.name as dataset_name, TO_CHAR(bd.release_date, 'YYYY-MON-DD') as release_date, dh.note, dp.dataset_sha1_digest , dh.build_number                                                 
   FROM  ApidbTuning.DatasetHistory dh, ApidbTuning.EupathBuildDates bd,  ApidbTuning.DatasetPresenter dp                        
   WHERE dh.build_number = bd.build_number                                                                                       
   AND dp.project_id = bd.project
   AND  dh.dataset_presenter_id = dp.dataset_presenter_id                                                                        
   ORDER by dh.build_number                                                                                                      
   ) ORDER by build_number                                                                                                       
            
	    ]]>
        </sql>
</sqlQuery>


      <sqlQuery name="AccessRequestStats"  isCacheable="false" includeProjects="ClinEpiDB">
            <column name="dataset_id"/>
            <column name="dataset_name"/>
            <column name="total"/>
            <column name="approved"/>
            <column name="approved_percent"/>
            <sql>
              <![CDATA[


select pres.dataset_presenter_id as dataset_id, pres.name as dataset_name, total, approved, ROUND(100*approved/total,0)||'%' as approved_percent
from  apidbtuning.datasetpresenter pres,
(
  select eu.DATASET_PRESENTER_ID,  
         count(*) as total, 
         count(case when approval_status_id = 0 then 1 end) as approved
  from studyaccess.end_users@ACCT_DBLINK@ eu, apidbtuning.datasetproperty dp
  where eu.dataset_presenter_id = dp.DATASET_PRESENTER_ID
     and property = 'studyAccess'
     and value != 'public'
  group by eu.dataset_presenter_id
  order by eu.dataset_presenter_id
) mycounts
where pres.dataset_presenter_id = mycounts.dataset_presenter_id
and total != 0

               ]]>

            </sql>
      </sqlQuery>





      <sqlQuery name="AccessRequest"  isCacheable="false" includeProjects="ClinEpiDB">
	    <column name="dataset_id"/>
	    <column name="dataset_name"/>
            <column name="name"/>
            <column name="organization"/>
	    <column name="start_date"/>
	    <column name="purpose"/>
            <sql>
              <![CDATA[
SELECT t1.name,
       t2.value as organization, 
       to_char(CAST(t3.start_date AS DATE) , 'YYYY-MM-DD' ) as start_date, 
       t3.purpose,
       t4.dataset_presenter_id as dataset_id, 
       t4.name as dataset_name
FROM 
(
  SELECT user_id, listagg(value,' ') within group( order by key ) as name
   FROM (
         SELECT *
         FROM (
             SELECT user_id, key, value
             FROM useraccounts.account_properties@ACCT_DBLINK@ where key in ('first_name', 'last_name')
        ))
   GROUP BY user_id
 ) t1,
(
  SELECT user_id, value
   FROM useraccounts.account_properties@ACCT_DBLINK@
  WHERE key in ('organization')
) t2,
(
  SELECT user_id, dataset_presenter_id, start_date, purpose, a.name AS approval_status
   FROM studyaccess.end_users@ACCT_DBLINK@ v
     INNER JOIN studyaccess.approval_status@ACCT_DBLINK@ a
       ON v.approval_status_id = a.approval_status_id
   WHERE a.name = 'approved'
) t3,
(
  SELECT dataset_presenter_id, name FROM apidbtuning.datasetpresenter
) t4
  WHERE t1.user_id = t2.user_id 
    and t1.user_id = t3.user_id  
    and t3.dataset_presenter_id = t4.dataset_presenter_id
ORDER by start_date desc

 ]]>

            </sql>
      </sqlQuery>




      <sqlQuery name="Isolates"  isCacheable='false' excludeProjects="MicrobiomeDB">
            <column name="dataset_name"/>
            <column name="dataset_id"/>
            <column name="source_id"/>
            <column name="strain"/>
            <column name="contact_name"/>
            <sql excludeProjects="Piroplasma,EuPathDB">
            <![CDATA[
                     select ia.source_id,
                     ia.project_id,
                     ds.name as dataset_name,
                     iads.dataset_presenter_id as dataset_id,
                     ia.strain,
                     listagg(iac.name, ',') within group (order by iac.name) as contact_name
                     from study.Study s, apidb.Datasource ds, sres.ExternalDatabase d,
                          sres.ExternalDatabaseRelease r, rad.StudyBiomaterial sb,
                          ApidbTuning.PopsetAttributes ia,
                          ApidbTuning.DatasetNameTaxon iads,
                          ApidbTuning.DatasetContact iac
                     where s.external_database_release_id = r.external_database_release_id
                     and r.external_database_id = d.external_database_id
                     and ds.name = d.name
                     and ds.version = r.version
                     and s.study_id = sb.study_id
                     and sb.bio_material_id = ia.bio_material_id
                     and ia.experiment_external_db_name = iads.name
                     and iads.dataset_presenter_id = iac.dataset_presenter_id (+)
                     group by iads.dataset_presenter_id, ia.source_id, ia.project_id, ds.name, ia.strain
            ]]>
            </sql>
            <sql includeProjects="EuPathDB">
            <![CDATA[
                     select '' as source_id,
                     '' as project_id,
                     name as dataset_name,
                     dataset_presenter_id as dataset_id,
                     '' as strain,
                     '' as  contact_name
                     from ApidbTuning.DatasetPresenter ds
                     where ds.name = 'no isolates for portal'
            ]]>
            </sql>

      </sqlQuery>



      <sqlQuery name="HyperLinks"  isCacheable='false'>
            <column name="dataset_id"/>
            <column name="text"/>
            <column name="url"/>
            <column name="description"/>

	    <sql>
          SELECT dataset_presenter_id AS dataset_id
              , text
              , url
              , description
          FROM ApidbTuning.DatasetHyperLINK
          WHERE url not like '/%'
          AND url not like '%genedb.org%'
          AND (isPublication != 'Y' OR isPublication is null)
      </sql>

      </sqlQuery>


      <sqlQuery name="References"  isCacheable='false'  excludeProjects="MicrobiomeDB,ClinEpiDB">
            <column name="dataset_id"/>
            <column name="dataset_name"/>
            <column name="text"/>
            <column name="url"/>
            <column name="description"/>
            <column name="record_type"/>
            <column name="target_type"/>
            <column name="target_name"/>
            <column name="link_type"/>
            <sql excludeProjects="EuPathDB">
            <![CDATA[
		with projectQuestionLinks as (
		    select dsp.dataset_presenter_id as dataset_id
			, dsp.name as dataset_name
                        , '' as text
			, '' as url
			, '' as description
			, ref.record_type
                        , ref.target_type
			, replace (ref.target_name, ':', '') as target_name
			, 'question' as link_type
		    from ApidbTuning.datasetmodelref ref
		    left join ApidbTuning.DatasetPresenter dsp
			on dsp.dataset_presenter_id = ref.dataset_presenter_id
                    where NOT (dsp.name='_IEDB(.*)RSRC$' and '@PROJECT_ID@' = 'HostDB')
		    order by dsp.name
                        , ref.target_type
                        , ref.record_type
			, ref.target_name
		)

	        select dataset_presenter_id as dataset_id
		        , '' as dataset_name
                        , text
		        , url
		        , description
		        , '' as record_type
                        , '' as target_type
		        , '' as target_name
		        , 'genomicsInternal' as link_type
	        from apidbtuning.GenomicsInternalHyperlink
	        where url not like '%app/record/organism/%'
                union
		select dsp.dataset_presenter_id as dataset_id
		       , '' as dataset_name
		       , 'View this Data Set in MapVEu' as text
		       , '/popbio-map/web/?projectID=' || p.value as url
		       , 'View this Data Set in MapVEu' as description
		       , '' as record_type
		       , '' as target_type
		       , '' as target_name
		       , 'genomicsInternal' as link_type
		from apidbtuning.datasetpresenter dsp, apidbtuning.datasetproperty p
		where dsp.name like 'PopBio_Study%' and dsp.dataset_presenter_id = p.dataset_presenter_id
		      and p.property = 'vbId'
		union
	        select * from projectQuestionLinks
                order by text
	    ]]>
            </sql>

	    <sql includeProjects="EuPathDB">
            <![CDATA[
               with projectQuestionLinks as (
select dsp.dataset_presenter_id as dataset_id
                        , dsp.name as dataset_name
                        , '' as text
                        , '' as url
                        , '' as description
                        , ref.record_type
                        , ref.target_type
                        , replace (ref.target_name, ':', '') as target_name
                        , 'question' as link_type
                    from ApidbTuning.datasetmodelref ref
                    left join ApidbTuning.DatasetPresenter dsp
                        on dsp.dataset_presenter_id = ref.dataset_presenter_id
                    where NOT (dsp.name='_IEDB(.*)RSRC$' and '@PROJECT_ID@' = 'HostDB')
                    order by dsp.name
                        , ref.target_type
                        , ref.record_type
                        , ref.target_name
),
mygih as (
 select DATASET_PRESENTER_ID,DESCRIPTION, substr(text, 1, instr(text,' ',-1)-1 ) as text, URL
   from   apidbtuning.GenomicsInternalHyperlink
)
                -- these links should be opened in component sites
                select gih.dataset_presenter_id as dataset_id
                        , '' as dataset_name
                        , text
                        , 'https://' || dsp.project_id || '.org' || gih.url  as url
                        , gih.description
                        , '' as record_type
                        , '' as target_type
                        , '' as target_name
                        , 'genomicsInternal' as link_type
                from apidbtuning.GenomicsInternalHyperlink gih, apidbtuning.datasetpresenter dsp
                where gih.dataset_presenter_id = dsp.dataset_presenter_id
                  and url not like '%app/record/organism/%'
                  and url not like '%app/search/transcript/%'
                union
                -- these links can be opened in portal
                select mygih.dataset_presenter_id as dataset_id
                        , '' as dataset_name
                        , text || ' VEuPathDB' as text
                        , url
                        , mygih.description
                        , '' as record_type
                        , '' as target_type
                        , '' as target_name
                        , 'genomicsInternal' as link_type
                from mygih, apidbtuning.datasetpresenter dsp
                where mygih.dataset_presenter_id = dsp.dataset_presenter_id
                  and (url like '%app/search/transcript/%'  or  url like '%app/record/dataset/%') 
                union
                select dsp.dataset_presenter_id as dataset_id
                       , '' as dataset_name
                       , 'View this Data Set in MapVEu' as text
                       , '/popbio-map/web/?projectID=' || p.value as url
                       , 'View this Data Set in MapVEu' as description
                       , '' as record_type
                       , '' as target_type
                       , '' as target_name
                       , 'genomicsInternal' as link_type
                from apidbtuning.datasetpresenter dsp, apidbtuning.datasetproperty p
                where dsp.name like 'PopBio_Study%' and dsp.dataset_presenter_id = p.dataset_presenter_id
                      and p.property = 'vbId'
                union
                select * from projectQuestionLinks
                order by text

            ]]>
            </sql>
      </sqlQuery>

      <sqlQuery name="Version"  isCacheable='false'>
            <column name="dataset_name"/>
            <column name="dataset_id"/>
            <column name="version"/>
            <column name="organism"/>
            <column name="project_id"/>
            <sql excludeProjects="EuPathDB">
            <![CDATA[
                    with TaxonScientificName as (
                    select taxon_id,name
                    from sres.taxonname where
                    name_class = 'scientific name')
                    select dataset_name, dataset_id,organism, version, '@PROJECT_ID@' as project_id
                    from (
                      select distinct dnt.name as dataset_name,
                           dnt.dataset_presenter_id as dataset_id,
                           case when dnt.taxon_id = 0
                           then 'ALL'
                           else tn.name
                           end as organism,
                            replace (ds.version, '_gus4','') as version
                      from TaxonScientificName tn, ApidbTuning.DatasetNameTaxon dnt,
                          apidb.datasource ds
                      where dnt.taxon_id = tn.taxon_id(+)
                      and   ds.name = dnt.name
                      order by dnt.name
                    )

            ]]>
            </sql>
            <sql includeProjects="EuPathDB">
              WITH TaxonScientificName AS (
                    SELECT component_taxon_id  as taxon_id, organism_name as name
                    FROM apidbtuning.organismattributes 
              ) SELECT dataset_name, dataset_id,organism, version, project_id
                FROM (
                    select distinct dnt.name as dataset_name, ds.project_id,
                           dnt.dataset_presenter_id as dataset_id,
                           case when dnt.taxon_id = 0
                           then 'ALL'
                           else tn.name
                           end as organism,
                            replace (ds.version, '_gus4','') as version
                      from TaxonScientificName tn, ApidbTuning.DatasetNameTaxon dnt,
                           apidb.datasource ds
                      where dnt.taxon_id = tn.taxon_id(+)
                      and  ds.name = dnt.name
                      and not ds.taxon_id is null
                     order by dnt.name
                )
            </sql>
      </sqlQuery>





      <sqlQuery name="ExampleGraphs">
            <column name="source_id" />
            <column name="project_id" />
            <column name="graph_ids" />
            <column name="default_graph_id" />
            <column name="module" />
            <column name="mainOpen" />
            <column name="dataOpen" />
            <column name="display_name" />
            <column name="description" />
            <column name="x_axis" />
            <column name="y_axis" />
            <column name="has_graph_data"/>
	    <column name="has_meta_data"/>
	    <column name="meta_data_categories"/>
            <column name="dataset_name"/>
            <column name="dataset_id"/>
            <column name="is_graph_custom"/>
            <column name="assay_type"/>
            <column name="template"/>

            <!-- force no plots on dataset record while avoiding datasetexamplesourceid for mbio, clinepi-->
            <sql includeProjects="EuPathDB, MicrobiomeDB, ClinEpiDB">
            <![CDATA[
 select '' as source_id,
            '' as project_id,
            '' as graph_ids,
            '' as default_graph_id,
            '' as module,
            '' as mainOpen,
            '' as dataOpen,
            '' as display_name,
            '' as description,
            '' as x_axis,
            '' as y_axis,
            '' as has_graph_data,
            '' as has_meta_data,
            '' as meta_data_categories,
            '' as is_graph_custom,
            '' as summary,
            '' as short_attribution,
            '' as assay_type,
            '' as template,
                     name as dataset_name,
                     dataset_presenter_id as dataset_id
                     from ApidbTuning.DatasetPresenter ds
                     where ds.name = 'no graphs for portal'

            ]]>
            </sql>

            <sql excludeProjects="EuPathDB, MicrobiomeDB, ClinEpiDB">
            <![CDATA[

select g.*, decode(lower(is_graph_custom), 'false', 1, 0) as template, regexp_substr(graph_ids, '[^,]*') as default_graph_id
from (
select
p.example_source_id as source_id,
       '@PROJECT_ID@' as project_id,
       graph_descrip.dataset as dataset_name,
       p.example_source_id as graph_ids,
       dnt.dataset_presenter_id as dataset_id,
       '1' as has_graph_data,
       'FALSE' as has_meta_data,
       '' as graph_organism,
       'TRUE' as mainOpen,
       'FALSE' as dataOpen,
       '' as meta_data_categories,
       graph_descrip.*--,

from (

select '' as dataset,
       '' as display_name,
       '' as description,
       '' as module,
       '' as x_axis,
       '' y_axis,
       '' as is_graph_custom,
       'other' as assay_type,
       1 as order_num

       from dual
      -- TEMPLATE_ANCHOR datasetExampleGraphDescriptions
       ) graph_descrip, ApidbTuning.datasetexamplesourceid p,
       ApidbTuning.datasetnametaxon dnt
where p.dataset = graph_descrip.dataset
and graph_descrip.dataset = dnt.name) g
             ]]>
            </sql>
      </sqlQuery>

      <sqlQuery name="TranscriptTypeCounts" excludeProjects="MicrobiomeDB,ClinEpiDB">
            <column name="dataset_id"/>
            <column name="gene_type"/>
            <column name="transcript_type"/>
            <column name="transcript_count"/>

            <sql excludeProjects="MicrobiomeDB,ClinEpiDB">
              select dsp.dataset_presenter_id as dataset_id
                , ta.gene_type
                , ta.transcript_type
                , count(*) as transcript_count
              from apidbtuning.organismattributes oa
                , apidbtuning.transcriptattributes ta
                , apidbtuning.datasetpresenter dsp
                , apidbtuning.datasetnametaxon dnt
              where oa.component_taxon_id = ta.taxon_id
              and oa.project_id = ta.project_id
              and oa.component_taxon_id = dnt.taxon_id
              and dnt.dataset_presenter_id = dsp.dataset_presenter_id
              and dsp.type = 'genome'
              group by oa.project_id, dsp.dataset_presenter_id, ta.gene_type, ta.transcript_type
              order by count(*) desc
            </sql>

      </sqlQuery>

      <sqlQuery name="GeneTypeCounts" excludeProjects="MicrobiomeDB,ClinEpiDB">
            <column name="dataset_id"/>
            <column name="gene_type"/>
            <column name="gene_count"/>

            <sql excludeProjects="MicrobiomeDB,ClinEpiDB">
              select dsp.dataset_presenter_id as dataset_id
                , ga.gene_type
                , count(*) as gene_count
              from apidbtuning.organismattributes oa
                , apidbtuning.geneattributes ga
                , apidbtuning.datasetpresenter dsp
                , apidbtuning.datasetnametaxon dnt
              where oa.component_taxon_id = ga.taxon_id
              and oa.project_id = ga.project_id
              and oa.component_taxon_id = dnt.taxon_id
              and dnt.dataset_presenter_id = dsp.dataset_presenter_id
              and dsp.type = 'genome'
              group by oa.project_id, dsp.dataset_presenter_id, ga.gene_type
              order by count(*) desc
            </sql>

      </sqlQuery>

      <sqlQuery name="SequenceTypeCounts" excludeProjects="EuPathDB,MicrobiomeDB,ClinEpiDB">
            <column name="dataset_id"/>
            <column name="sequence_type"/>
            <column name="sequence_count"/>

            <sql excludeProjects="EuPathDB,MicrobiomeDB,ClinEpiDB">
              select dsp.dataset_presenter_id as dataset_id
                , sa.sequence_type
                , count(*) as sequence_count
              from apidbtuning.organismattributes oa
                , ApidbTuning.GenomicSeqAttributes sa
                , apidbtuning.datasetpresenter dsp
                , apidbtuning.datasetnametaxon dnt
              where oa.component_taxon_id = sa.taxon_id
              and oa.project_id = sa.project_id
              and oa.component_taxon_id = dnt.taxon_id
              and dnt.dataset_presenter_id = dsp.dataset_presenter_id
              and dsp.type = 'genome'
              group by dsp.dataset_presenter_id, sa.sequence_type
              order by count(*) desc
            </sql>

      </sqlQuery>


       <sqlQuery name="GenomeAssociatedData" excludeProjects="MicrobiomeDB,ClinEpiDB,EuPathDB">
            <column name="dataset_id"/>
            <column name="category"/>
            <column name="dataset_count"/>
            <column name="organism"/>
            <sql excludeProjects="MicrobiomeDB,ClinEpiDB,EuPathDB">
             select dataset_id, category, organism, count(*) as dataset_count from (
              select dsp.dataset_presenter_id as dataset_id
                , nvl(o_dsp.display_category, o_dsp.category) as category
                , tn.name as organism
              from apidbtuning.organismattributes oa
                , apidbtuning.datasetpresenter o_dsp
                , apidbtuning.datasetnametaxon o_dnt
                , apidbtuning.datasetnametaxon dnt
                , sres.taxonname tn
                , apidbtuning.datasetpresenter dsp
              where oa.component_taxon_id = o_dnt.taxon_id
              and o_dnt.dataset_presenter_id = o_dsp.dataset_presenter_id
              and oa.component_taxon_id = dnt.taxon_id
              and dnt.dataset_presenter_id = dsp.dataset_presenter_id
              and dnt.taxon_id = tn.taxon_id
              and tn.name_class = 'scientific name'
              and dsp.type = 'genome'
              and o_dsp.category not in ('Genomics', 'Link outs')
              )
              group by dataset_id, category, organism
            order by count(*) desc
            </sql>

      </sqlQuery>


      <sqlQuery name="ExternalDatabases" excludeProjects="EuPathDB,MicrobiomeDB,ClinEpiDB">
            <column name="dataset_id"/>
            <column name="name"/>
            <column name="id_url"/>
            

            <sql excludeProjects="EuPathDB,MicrobiomeDB,ClinEpiDB">
		   <![CDATA[
                    SELECT DISTINCT dataset_id, name, id_url FROM (
                    with full_urls_table as (
			      select dsp.dataset_presenter_id as dataset_id 
			      , ext.dataset as name, id_url
			      from apidbtuning.datasetnametaxon dnt, apidbtuning.datasetpresenter dsp,
			      (
			      SELECT dataset
			      , taxon_id
                              , id_url
			      FROM apidbTuning.DatabaseTaxonUrl
			      WHERE dataset != 'GeneDB: The Sanger Institute Pathogen Genomics Database'
			      AND dataset != 'protein_id'
			      ) ext
			      where ext.taxon_id = dnt.taxon_id
			      and dnt.dataset_presenter_id = dsp.dataset_presenter_id
			      and dsp.type = 'genome'
			      )
		select dataset_id
		  , name
		  , nvl(decode(substr(id_url,0, instr(id_url, '/', 1, 3)),
                      'http://version_10.string-db.org/', 'http://string-db.org/'), substr(id_url,0, instr(id_url, '/', 1, 3))) as id_url
		from full_urls_table
                ) order by name
                  ]]>
            </sql>

      </sqlQuery>

<!--
      <sqlQuery name="DatasetGeneTable"  isCacheable='false'>
        <column name="dataset_id"/>
        <column name="source_id"/>
        <column name="fdiff"/>
        <column name="min_value"/>
        <column name="min_timepoint"/>
        <column name="max_value"/>
        <column name="max_timepoint"/>
        <sql>
        <![CDATA[
          select dataset_presenter_id as dataset_id, dataset_name, source_id,
                 fdiff, min_value, min_timepoint, max_value, max_timepoint
          from ApidbTuning.DatasetGeneList
        ]]>
       </sql>
      </sqlQuery>
-->

      <sqlQuery name="AssociatedDatasets"  isCacheable='false'>
            <column name="dataset_id"/>
            <column name="pmid"/>
            <column name="associated_dataset_id"/>
            <column name="project"/>
            <column name="webapp_name"/>
            <column name="display_name"/>
            <sql>
            <![CDATA[
             select local_dataset_id as dataset_id, pubmed_id as pmid,
                     associated_dataset_id, project, webapp_name, display_name
             from ApidbTuning.AssociatedDataset
             where (local_project = '@PROJECT_ID@' or '@PROJECT_ID@' = 'EuPathDB')
             order by local_dataset_id
            ]]>
            </sql>
      </sqlQuery>


      <sqlQuery name="Busco" excludeProjects="EuPathDB,HostDB,MicrobiomeDB,ClinEpiDB">
        <column name="dataset_id"/>
        <column name="sequence_type"/>
        <column name="c_score"/>
        <column name="s_score"/>
        <column name="d_score"/>
        <column name="f_score"/>
        <column name="m_score"/>
        <column name="lineage_dataset"/>
        <sql>
            SELECT dsp.dataset_presenter_id as dataset_id,
                sequence_type,
                to_char(c_score /(c_score + f_score + m_score) * 100, '990.9') || '%' AS c_score,
                to_char(s_score /(c_score + f_score + m_score) * 100, '990.9') || '%'AS s_score,
                to_char(d_score /(c_score + f_score + m_score) * 100, '990.9') || '%'AS d_score,
                to_char(f_score /(c_score + f_score + m_score) * 100, '990.9') || '%'AS f_score,
                to_char(m_score /(c_score + f_score + m_score) * 100, '990.9') || '%'AS m_score,
                lineage_dataset
            FROM
                apidbtuning.organismattributes oa,
                apidb.organism                 o,
                apidb.busco                    b
                , apidbtuning.datasetpresenter dsp
                , apidbtuning.datasetnametaxon dnt
            WHERE b.organism_id = o.organism_id
              AND o.taxon_id = oa.component_taxon_id
              AND oa.component_taxon_id = dnt.taxon_id
              AND dnt.dataset_presenter_id = dsp.dataset_presenter_id
              AND dsp.type='genome'
        </sql>
      </sqlQuery>

      <sqlQuery name="UdDependencies"  isCacheable='false'>
            <column name="dataset_id"/>
            <column name="identifier"/>
            <column name="display_name"/>
            <column name="version"/>
            <sql>
            <![CDATA[
             select CONCAT('EDAUD_', user_dataset_id) as dataset_id,
                identifier, display_name, version
                from @VDI_CONTROL_SCHEMA@.dataset_dependencies
            ]]>
            </sql>
      </sqlQuery>

    </querySet>

    <querySet name="DatasetReleaseNotesTables" queryType="table"
              isCacheable='false'>


      <sqlQuery name="ReleaseNotes"  isCacheable='false'>
            <column name="release_notes_id"/>
            <column name="build_number"/>
            <column name="release_date"/>
            <column name="dataset_id"/>
            <column name="dataset_name"/>
            <column name="note"/>
            <sql>
            <![CDATA[
             select '111' as release_notes_id, bd.build_number, bd.release_date,
                    dh.dataset_presenter_id as dataset_id, dp.name as dataset_name, dh.note
             from ApidbTuning.DatasetHistory dh, ApidbTuning.EupathBuildDates bd,
                  ApidbTuning.DatasetPresenter dp
             where dh.build_number = bd.build_number
             and dh.dataset_presenter_id = dp.dataset_presenter_id
             order by dh.build_number
            ]]>
            </sql>
      </sqlQuery>

    </querySet>

</wdkModel>
